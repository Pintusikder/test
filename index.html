<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ArthaNex - Digital Khata Book">

    <title>ArthaNex - Best Free Khata Book App | Udhar Bahi Khata | Business Ledger 2025</title>
    <meta name="description" content="Best free offline Khata Book app for small business. Digital Udhar Bahi Khata, Credit Debit Ledger, Daily Cash Book, Money Manager without internet. Download Bahi Khata app now!">
    <meta name="keywords" content="khata book, udhar bahi khata, digital ledger app, credit debit book, cash book app, business khata, shop management app, money manager, hisab kitab app, dukan ka hisab">
    <meta name="theme-color" content="#F67B34">
    <meta name="robots" content="index, follow">
    <meta name="author" content="Arthixa">
    <meta name="language" content="English">
    
    <!-- Content Security Policy - Updated for local logo -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.highperformanceformat.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self';">
    
    <!-- Hreflang for multilingual support -->
    <link rel="alternate" hreflang="en" href="https://github.com/Pintusikder/arthanex">
    <link rel="alternate" hreflang="bn" href="https://github.com/Pintusikder/arthanex/bn">
    <link rel="alternate" hreflang="hi" href="https://github.com/Pintusikder/arthanex/hi">
    <link rel="alternate" hreflang="x-default" href="https://github.com/Pintusikder/arthanex">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://github.com/Pintusikder/arthanex">
    <meta property="og:title" content="ArthaNex - Free Digital Khata Book & Business Ledger App">
    <meta property="og:description" content="Manage your business udhar hisab easily. Best Khata Book app with credit debit tracking, bill book, and cash management. 100% offline.">
    <meta property="og:image" content="https://github.com/Pintusikder/arthanex/logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://github.com/Pintusikder/arthanex">
    <meta property="twitter:title" content="ArthaNex - Free Khata Book & Udhar Bahi App">
    <meta property="twitter:description" content="Best digital bahi khata for small business. Track credit, debit, daily expenses without internet.">
    <meta property="twitter:image" content="https://github.com/Pintusikder/arthanex/logo.png">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://github.com/Pintusikder/arthanex">

    <!-- Structured Data / Schema.org -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "ArthaNex - Khata Book & Business Ledger",
        "description": "Best free offline Khata Book app for managing business udhar, credit debit, daily cash collection and party ledger without internet.",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Android, iOS, Windows, MacOS, Linux",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "15000"
        },
        "featureList": "Offline Khata Book, Udhar Bahi, Credit Debit Ledger, Daily Cash Book, Bill Management, PIN Lock, Data Encryption, Multi Profile, PDF Export, 50+ Currencies",
        "softwareVersion": "2.3.0",
        "fileSize": "150KB",
        "downloadUrl": "https://github.com/Pintusikder/arthanex",
        "screenshot": "https://github.com/Pintusikder/arthanex/logo.png",
        "author": {
            "@type": "Organization",
            "name": "Arthixa",
            "url": "https://github.com/Pintusikder"
        }
    }
    </script>

    <!-- FAQ Schema for Rich Snippets -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [{
            "@type": "Question",
            "name": "What is the best Khata Book app for small business?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "ArthaNex is the best free offline Khata Book app for small business. It works without internet, supports credit debit tracking, party ledger management, and generates PDF reports. It supports 50+ countries and currencies."
            }
        }, {
            "@type": "Question",
            "name": "How to maintain Udhar Bahi Khata digitally?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Use ArthaNex digital Khata Book app to maintain your Udhar Bahi electronically. Track customer credit (udhar), debit payments, daily cash collection, and generate instant reports. All data is encrypted and stored locally on your device."
            }
        }, {
            "@type": "Question",
            "name": "Is there any offline Khata Book app?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Yes, ArthaNex is a 100% offline Khata Book app that works without internet. Your business data remains secure on your device with PIN lock and AES-256 encryption. No data is sent to any server."
            }
        }]
    }
    </script>

    <!-- Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #F67B34;
            --primary-hover: #D65612;
            --accent: #FF8A3D;
            --secondary: #1C1C1C;
            --neutral: #6B6E63;
            --light-bg: #F5F5F5;
            --card-bg: #FFFFFF;
            --input-bg: #FFFFFF;
            --text-color: #1C1C1C;
            --border: #999999;
            --bg-income: #e8f5e9;
            --text-income: #2e7d32;
            --bg-expense: #ffebee;
            --text-expense: #c62828;
            --bg-balance: #e3f2fd;
            --text-balance: #1565c0;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --history-text: #444444;
            --transition: all 0.3s ease;
            color-scheme: light;
        }

        [data-theme="dark"] {
            --secondary: #F5F5F5;
            --light-bg: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2c2c2c;
            --text-color: #F5F5F5;
            --border: #444444;
            --history-text: #cccccc;
            --bg-income: #1b3320;
            --text-income: #66bb6a;
            --bg-expense: #331515;
            --text-expense: #ef5350;
            --bg-balance: #0f2847;
            --text-balance: #42a5f5;
            color-scheme: dark;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--secondary);
            font-size: 16px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--light-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* HEADER */
        header {
            background-color: var(--primary);
            color: #fff;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .brand { display: flex; align-items: center; gap: 10px; flex-direction: column; align-items: flex-start; }
        .brand-top { display: flex; align-items: center; gap: 10px; width: 100%; }
        .brand h1 { font-size: 1.25rem; font-weight: 700; margin: 0; line-height: 1; }

        .current-profile-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
            cursor: pointer;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            overflow: hidden;
            flex-shrink: 0;
        }
        .brand-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            padding: 2px;
        }

        .brand a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 0.7rem;
            opacity: 0.9;
            cursor: pointer;
            border-bottom: 1px dashed rgba(255,255,255,0.5);
            white-space: nowrap;
        }
        .brand a:hover { opacity: 1; color: #fff; }

        .header-actions button {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.6rem;
            cursor: pointer;
            padding: 8px 12px;
            margin-left: 8px;
            transition: var(--transition);
            line-height: 1;
        }
        .header-actions button:hover { transform: scale(1.1); }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 1rem;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 0.8rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
            border: 1px solid var(--border);
        }
        .stat-card.income { background-color: var(--bg-income); border-color: var(--text-income); }
        .stat-card.expense { background-color: var(--bg-expense); border-color: var(--text-expense); }
        .stat-card.balance { background-color: var(--bg-balance); border-color: var(--text-balance); }
        .stat-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; opacity: 0.8; margin-bottom: 5px; color: var(--text-income); }

        .stat-val {
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
            color: var(--text-income);
            word-break: break-all;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .stat-card.expense .stat-label, .stat-card.expense .stat-val { color: var(--text-expense); }
        .stat-card.balance .stat-label, .stat-card.balance .stat-val { color: var(--text-balance); }

        /* NAVIGATION */
        nav {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            gap: 5px;
            overflow-x: auto;
            flex-shrink: 0;
        }
        nav::-webkit-scrollbar { display: none; }

        .nav-btn {
            background: none;
            border: none;
            padding: 0.5rem 0.8rem;
            font-weight: 600;
            color: var(--neutral);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            white-space: nowrap;
            font-size: 0.85rem;
        }
        .nav-btn.active {
            background-color: rgba(243, 108, 33, 0.2);
            color: var(--primary);
            font-weight: 700;
            border: 1px solid rgba(243, 108, 33, 0.3);
            box-shadow: 0 2px 4px rgba(243, 108, 33, 0.15);
        }
        .nav-btn:focus { outline: 2px solid var(--primary); outline-offset: 2px; }

        main { flex: 1; overflow-y: auto; padding: 1rem; position: relative; padding-bottom: 100px; }
        .view { display: none; animation: fadeIn 0.3s ease; padding-bottom: 20px; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* HOME PAGE */
        .home-container { display: flex; flex-direction: column; gap: 1.5rem; }

        .home-hero {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            padding: 2.5rem 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: 0 8px 20px rgba(243, 108, 33, 0.3);
            position: relative;
            overflow: hidden;
        }
        .home-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            z-index: 0;
        }

        .home-logo-big {
            width: 80px;
            height: 80px;
            background: #fff;
            border-radius: 16px;
            padding: 10px;
            margin: 0 auto 1rem auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }
        .home-logo-big img { width: 100%; height: 100%; object-fit: contain; }

        .home-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; position: relative; z-index: 1; letter-spacing: -0.5px; }
        .home-subtitle { font-size: 1.1rem; font-weight: 500; opacity: 0.95; position: relative; z-index: 1; margin-bottom: 1.5rem; }
        .home-desc { font-size: 0.95rem; line-height: 1.6; opacity: 0.9; position: relative; z-index: 1; max-width: 80%; margin: 0 auto; }

        .features-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        .feature-poster {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 1.5rem 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }
        .feature-poster:active { transform: scale(0.98); }
        .feature-poster:focus-within { outline: 2px solid var(--primary); outline-offset: 2px; }
        .feature-icon-lg { font-size: 2.5rem; margin-bottom: 0.5rem; display: block; }
        .feature-poster h4 { color: var(--text-color); font-size: 0.9rem; font-weight: 700; margin-bottom: 0.25rem; }
        .feature-poster p { color: var(--neutral); font-size: 0.75rem; line-height: 1.3; margin: 0; }

        .home-credits {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }
        .home-credits h3 { color: var(--primary); font-size: 1rem; margin-bottom: 0.2rem; }
        .home-credits p { color: var(--neutral); font-size: 0.75rem; margin: 0; }
        .home-credits a { color: var(--primary); text-decoration: none; font-weight: 600; }

        /* OTHER STYLES */
        .card { background: var(--card-bg); border-radius: var(--radius-md); padding: 1.25rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--neutral); font-weight: 500; word-break: break-word; }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-family: inherit;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: var(--transition);
        }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(243, 108, 33, 0.2); }
        .form-control.error { border-color: #dc3545; background-color: rgba(220, 53, 69, 0.1); }
        .form-control:disabled { opacity: 0.5; cursor: not-allowed; background: var(--light-bg); }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; color: var(--primary); opacity: 1; }

        .radio-group, .checkbox-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 10px;
            background: var(--light-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }
        .radio-group label, .checkbox-wrapper label {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .checkbox-wrapper label { width: auto !important; }
        .checkbox-wrapper { cursor: pointer; }

        .denom-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.8rem; margin-top: 1rem; }
        .denom-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 0.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .denom-label { font-weight: 600; color: var(--neutral); font-size: 0.85rem; }
        .denom-input {
            width: 100%;
            padding: 4px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        .denom-subtotal { font-size: 0.7rem; color: var(--primary); font-weight: 500; }

        .total-display {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }
        .total-label { font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .total-amount { font-size: 2.2rem; font-weight: 700; margin: 0.5rem 0; font-family: 'Roboto Mono', monospace; word-break: break-all; }
        .total-words { font-style: italic; opacity: 0.9; font-size: 0.9rem; word-break: break-word; }

        .btn {
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            transition: var(--transition);
            width: 100%;
            white-space: nowrap;
        }
        .btn:focus { outline: 2px solid var(--primary); outline-offset: 2px; }
        .btn-primary { background-color: var(--primary); color: #fff; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn-secondary { background-color: var(--neutral); color: #fff; }
        .btn-success { background-color: #2e7d32; color: #fff; }
        .btn-outline { background-color: transparent; border: 1px solid var(--neutral); color: var(--neutral); }
        .btn-danger { background-color: #dc3545; color: #fff; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; width: auto; }

        /* TAGS STYLES */
        .tags-input-group { display: flex; gap: 8px; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .tag-chip {
            background-color: var(--bg-balance);
            color: var(--text-balance);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--text-balance);
        }
        .tag-close {
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.1);
        }
        .tag-close:focus { outline: 2px solid var(--primary); outline-offset: 2px; }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            color: var(--text-color);
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--neutral);
        }
        .modal-close:focus { outline: 2px solid var(--primary); outline-offset: 2px; }

        .history-list { list-style: none; }
        .history-item {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
        }
        .h-left { flex: 1; padding-right: 15px; min-width: 0; }
        .h-name { font-weight: 700; font-size: 1.05rem; color: var(--secondary); margin-bottom: 4px; display: block; word-break: break-word; line-height: 1.3; }
        .h-tags { margin-bottom: 4px; font-size: 0.75rem; color: var(--primary); }

        .h-details { display: flex; flex-direction: column; gap: 3px; font-size: 0.8rem; color: var(--history-text); font-weight: 500; }
        .h-detail-row { display: flex; align-items: center; gap: 6px; }
        .h-detail-row span { line-height: 1.2; word-break: break-word; }

        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; margin-right: 5px; white-space: nowrap; }
        .badge.due { background-color: #ffe0b2; color: #e65100; }
        .badge.expense { background-color: #ffcdd2; color: #c62828; }
        .badge.receivable { background-color: #e8f5e9; color: #2e7d32; }
        [data-theme="dark"] .badge.due { background-color: #5d4037; color: #ffcc80; }
        [data-theme="dark"] .badge.expense { background-color: #5c2b2b; color: #ef9a9a; }

        .h-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: flex-start; min-width: 80px; margin-left: 10px; }
        .h-amount { font-weight: 700; font-size: 1.1rem; margin-bottom: 2px; white-space: nowrap; }
        .amount-income { color: var(--primary); }
        .amount-expense { color: var(--text-expense); }
        .h-words { font-size: 0.7rem; font-style: italic; color: var(--history-text); text-align: right; margin-bottom: 4px; line-height: 1.1; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .menu-container { position: relative; display: inline-block; margin-top: auto; flex-shrink: 0; }
        .btn-menu {
            background: none;
            border: none;
            color: var(--history-text);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .btn-menu:hover { color: var(--primary); }
        .btn-menu:focus { outline: 2px solid var(--primary); outline-offset: 2px; border-radius: 4px; }
        .item-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--card-bg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-sm);
            z-index: 200;
            min-width: 140px;
            overflow: hidden;
            pointer-events: none;
        }
        .item-menu.show { display: block; pointer-events: auto; }
        .menu-opt {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-color);
            transition: background 0.2s;
            white-space: nowrap;
        }
        .menu-opt:hover { background-color: var(--light-bg); }
        .menu-opt:focus { outline: 2px solid var(--primary); outline-offset: -2px; }
        .menu-opt.delete { color: #dc3545; border-top: 1px solid var(--border); }

        .detail-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed var(--border); padding-bottom: 4px; font-size: 0.9rem; }
        .detail-row span:last-child { font-weight: 600; font-family: 'Roboto Mono', monospace; word-break: break-word; text-align: right; }
        .denom-breakdown { margin-top: 1rem; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px; background: var(--light-bg); }
        .denom-br-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem; }
        [data-theme="dark"] .denom-br-row { border-bottom: 1px solid rgba(255,255,255,0.05); }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--secondary);
            color: var(--card-bg);
            text-align: center;
            border-radius: var(--radius-md);
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: var(--shadow-md);
            width: max-content;
            max-width: 90%;
        }
        [data-theme="dark"] #toast { background-color: #F5F5F5; color: #121212; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* PWA INSTALL BANNER */
        #pwa-install-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--primary);
            color: #fff;
            padding: 1rem;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .pwa-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .pwa-title { font-weight: 700; font-size: 1rem; margin-bottom: 2px; }
        .pwa-desc { font-size: 0.8rem; opacity: 0.9; }

        .btn-install {
            background-color: #fff;
            color: var(--primary);
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .btn-install:focus { outline: 2px solid #fff; outline-offset: 2px; }
        .btn-close-pwa { background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; padding: 0; line-height: 1; }
        .btn-close-pwa:focus { outline: 2px solid #fff; outline-offset: 2px; border-radius: 4px; }

        .filter-container { display: flex; flex-direction: column; gap: 10px; }
        .filter-tabs { display: flex; background: var(--light-bg); padding: 4px; border-radius: var(--radius-md); border: 1px solid var(--border); }
        .filter-tabs input[type="radio"] { display: none; }
        .filter-tabs label { flex: 1; text-align: center; padding: 8px 5px; font-size: 0.8rem; font-weight: 600; color: var(--neutral); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .filter-tabs input[type="radio"]:checked + label { background-color: var(--card-bg); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .filter-tabs label:focus { outline: 2px solid var(--primary); outline-offset: 2px; }
        .filter-input-wrapper { width: 100%; }
        .filter-input { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--input-bg); color: var(--text-color); font-family: inherit; }
        .filter-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(243, 108, 33, 0.2); }

        .custom-select-wrapper { position: relative; user-select: none; width: 100%; }
        .custom-select { position: relative; display: flex; flex-direction: column; }
        .custom-select__trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            color: var(--text-color);
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }
        .custom-select__trigger:hover { border-color: var(--primary); }
        .custom-select.open .custom-select__trigger { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(243, 108, 33, 0.2); }
        .custom-select__options {
            position: absolute;
            display: block;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            box-shadow: var(--shadow-md);
            transition: all 0.3s;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            z-index: 50;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 5px;
        }
        .custom-select.open .custom-select__options { opacity: 1; visibility: visible; pointer-events: all; }
        .custom-select__search { padding: 10px; border-bottom: 1px solid var(--border); background: var(--card-bg); position: sticky; top: 0; z-index: 10; }
        .custom-select__search input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-color); }
        .custom-select__search input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(243, 108, 33, 0.2); }
        .custom-option {
            position: relative;
            display: block;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            word-break: break-word;
        }
        [data-theme="dark"] .custom-option { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .custom-option:hover { background-color: rgba(243, 108, 33, 0.1); color: var(--primary); }
        .custom-option:focus { outline: 2px solid var(--primary); outline-offset: -2px; }
        .custom-option.selected { background-color: var(--primary); color: #fff; }
        .arrow { position: relative; height: 10px; width: 10px; }
        .arrow::before, .arrow::after {
            content: "";
            position: absolute;
            bottom: 0px;
            width: 0.15rem;
            height: 100%;
            transition: all 0.3s;
        }
        .arrow::before { left: -3px; transform: rotate(-45deg); background-color: var(--neutral); }
        .arrow::after { left: 3px; transform: rotate(45deg); background-color: var(--neutral); }
        .open .arrow::before { left: -3px; transform: rotate(45deg); }
        .open .arrow::after { left: 3px; transform: rotate(-45deg); }
        .search-hint { font-size: 0.75rem; color: var(--neutral); margin-top: 5px; font-style: italic; }

        /* Profile List Styles */
        .profile-list { list-style: none; margin-top: 10px; }
        .profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            background: var(--card-bg);
        }
        .profile-item.active { border-color: var(--primary); background-color: rgba(243, 108, 33, 0.05); }
        .profile-name { font-weight: 600; font-size: 0.9rem; color: var(--text-color); }
        .profile-actions { display: flex; gap: 5px; }
        .profile-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }
        .profile-btn:focus { outline: 2px solid var(--primary); outline-offset: 2px; }
        .btn-switch { background-color: var(--primary); color: #fff; }
        .btn-delete { background-color: #dc3545; color: #fff; }

        .credits-container {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 0.5rem;
        }
        .credits-container h3 { color: var(--primary); font-size: 1.1rem; margin-bottom: 0.2rem; }
        .credits-container p { font-size: 0.9rem; color: var(--neutral); margin: 0.2rem 0; }
        .credits-container a { color: var(--primary); text-decoration: none; font-weight: 600; }

        /* PRINTABLE AREA */
        #print-area { display: none; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            body { counter-increment: page; }
            #print-area {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                color: #000;
                font-size: 12px;
                font-family: 'Helvetica', sans-serif;
                padding-bottom: 30px;
            }
            @page { size: A4; margin: 10mm 5mm 10mm 5mm; }
            /* PDF styles continue... */
            .pdf-header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 20px;
                border-bottom: 2px solid #F36C21;
                padding-bottom: 15px;
            }
            .pdf-logo-area { display: flex; align-items: center; gap: 10px; }
            .pdf-logo { width: 50px; height: 50px; object-fit: contain; }
            .pdf-title-block h1 { font-size: 24px; margin: 0; color: #F36C21; font-weight: 800; }
            .pdf-title-block h2 { font-size: 18px; margin: 5px 0 0 0; font-weight: 600; color: #333; }
            .pdf-meta { text-align: right; font-size: 11px; line-height: 1.5; color: #555; }
            .pdf-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
            .pdf-table th {
                background-color: #f4f4f4;
                color: #333;
                font-weight: 700;
                padding: 8px 5px;
                text-align: left;
                border-bottom: 2px solid #333;
                font-size: 10px;
            }
            .pdf-table td { padding: 6px 5px; border-bottom: 1px solid #ddd; vertical-align: top; }
            .pdf-table tr:nth-child(even) { background-color: #f9f9f9; }
            .row-green { background-color: #e8f5e9 !important; color: #1b5e20; }
            .row-orange { background-color: #fff3e0 !important; color: #e65100; }
            .row-red { background-color: #ffebee !important; color: #b71c1c; }
            .pdf-summary-box { margin-top: 20px; padding: 15px; border: 2px solid #333; background-color: #fafafa; margin-bottom: 35px; }
            .pdf-summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px dashed #ccc; }
            .pdf-summary-row:last-child { border-bottom: none; font-weight: bold; font-size: 13px; margin-top: 10px; padding-top: 10px; border-top: 2px solid #333; }
            .pdf-summary-label { font-weight: 600; }
            .pdf-summary-val { font-family: 'Courier New', monospace; font-weight: 600; }
            .pdf-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 30px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 9px;
                color: #777;
                border-top: 1px solid #ddd;
                background: #fff;
                z-index: 9999;
                line-height: 1.2;
            }
            .pdf-footer::before { content: "Generated by ArthaNex"; position: absolute; left: 10px; }
            .pdf-footer::after { content: "Page No " counter(page); position: absolute; right: 10px; }
        }

        /* Mobile Responsive */
        @media (max-width: 480px) {
            #userGuideModal .modal-content { max-width: 100% !important; margin: 0 !important; border-radius: 0 !important; max-height: 100vh !important; }
            #userGuideModal .modal-content > div { max-height: 100vh !important; }
            #userGuideModal .modal-content > div:nth-child(2) { padding: 1rem !important; }
        }

        @media (max-width: 768px) {
            #userGuideModal .modal-content { max-width: 95% !important; }
        }

        @supports (padding-top: env(safe-area-inset-top)) {
            #userGuideModal .modal-content {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Skip to main content link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: #fff;
            padding: 8px 16px;
            z-index: 10000;
            transition: top 0.3s;
        }
        .skip-link:focus { top: 0; }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border: #000;
                --primary: #000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
<base target="_blank">
</head>
<body data-theme="light">
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div id="app-container">
        <header role="banner" itemscope itemtype="https://schema.org/WPHeader" aria-label="App Header">
            <div class="brand">
                <div class="brand-top">
                    <div class="brand-icon" aria-hidden="true">
                        <img src="./logo.png" alt="ArthaNex Logo">
                    </div>
                    <div>
                        <h1>ArthaNex</h1>
                        <div class="current-profile-badge" id="headerProfileName" onclick="app.toggleModal('settingsModal')" role="button" tabindex="0" aria-label="Current profile, click to change">My Business</div>
                    </div>
                </div>
                <a href="https://github.com/Pintusikder" target="_blank" rel="noopener noreferrer">by Arthixa</a>
            </div>
            <div class="header-actions">
                <button id="settingsBtn" aria-label="Settings" title="Settings">&#9881;</button>
            </div>
        </header>

        <div style="width: 100%; text-align: center; margin: 10px 0; background-color: #fff; padding: 5px 0;">
            <script>
                atOptions = {
                    'key' : '37aea13fbdf3f7cf958070dd70143f8d',
                    'format' : 'iframe',
                    'height' : 50,
                    'width' : 320,
                    'params' : {}
                };
            </script>
            <script src="https://www.highperformanceformat.com/37aea13fbdf3f7cf958070dd70143f8d/invoke.js"></script>
        </div>

        <!-- Second Ad Banner -->
        <div style="width: 100%; text-align: center; margin: 10px 0; background-color: #fff; padding: 5px 0;">
            <script>
                atOptions = {
                    'key' : '37aea13fbdf3f7cf958070dd70143f8d',
                    'format' : 'iframe',
                    'height' : 50,
                    'width' : 320,
                    'params' : {}
                };
            </script>
            <script src="https://www.highperformanceformat.com/37aea13fbdf3f7cf958070dd70143f8d/invoke.js"></script>
        </div>

        <div class="dashboard-container" role="region" aria-label="Dashboard Statistics">
            <div class="stat-card income" role="status" aria-label="Total Income">
                <div class="stat-label">Income</div>
                <div class="stat-val" id="dashIncome" aria-live="polite">0</div>
            </div>
            <div class="stat-card expense" role="status" aria-label="Total Expenses">
                <div class="stat-label">Expenses</div>
                <div class="stat-val" id="dashExpense" aria-live="polite">0</div>
            </div>
            <div class="stat-card balance" role="status" aria-label="Net Balance">
                <div class="stat-label">Balance</div>
                <div class="stat-val" id="dashBalance" aria-live="polite">0</div>
            </div>
        </div>

        <nav role="navigation" aria-label="Main Navigation">
            <button class="nav-btn" onclick="app.switchTab('home')" aria-label="Home" aria-current="page">Home</button>
            <button class="nav-btn" onclick="app.switchTab('entry')" aria-label="New Entry">Entry</button>
            <button class="nav-btn" onclick="app.switchTab('history')" aria-label="History">History</button>
            <button class="nav-btn" onclick="app.switchTab('outstanding')" aria-label="Outstanding Dues">Dues</button>
            <button class="nav-btn" onclick="app.switchTab('ledger')" aria-label="Party Ledger">Ledger</button>
        </nav>

        <main role="main" id="main-content" itemscope itemtype="https://schema.org/WebPageElement">
            <!-- HOME SECTION -->
            <section id="home" class="view active" aria-label="Home">
                <div class="home-container">
                    <div class="home-hero">
                        <div class="home-logo-big" aria-hidden="true">
                            <img src="./logo.png" alt="ArthaNex - Digital Khata Book App">
                        </div>
                        <h1 class="home-title">ArthaNex</h1>
                        <h2 class="home-subtitle">Best Free Khata Book & Udhar Bahi App</h2>
                        <p class="home-desc">The #1 <strong>Offline Khata Book App</strong> for small business. Manage <strong>Udhar Bahi Khata</strong>, Credit Debit Ledger, Daily Cash Collection & Party Dues without internet. Best <strong>Digital Bahi Khata</strong>, Money Manager & Bill Book for shopkeepers. <strong>100% Free, Secure & Private.</strong></p>
                        <meta itemprop="description" content="Best Khata Book app for business accounting, udhar tracking, and credit debit management. Free offline ledger app.">

                        <p style="font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.2); display: inline-block; padding: 4px 12px; border-radius: 20px; margin-top: 15px; position: relative; z-index: 1;">
                            &#127757; Supports 50+ Countries & Currencies
                        </p>
                    </div>

                    <div class="features-grid">
                        <div class="feature-poster" itemscope itemtype="https://schema.org/ListItem" tabindex="0" aria-label="Offline Khata Book Feature">
                            <span class="feature-icon-lg" aria-hidden="true">&#128241;</span>
                            <h4 itemprop="name">Offline Khata Book</h4>
                            <p itemprop="description">Digital Udhar Bahi Khata. Track Cash, Credit & Debit 100% Offline without internet.</p>
                            <meta itemprop="position" content="1">
                        </div>
                        <div class="feature-poster" itemscope itemtype="https://schema.org/ListItem" tabindex="0" aria-label="Cash Book Feature">
                            <span class="feature-icon-lg" aria-hidden="true">&#128176;</span>
                            <h4 itemprop="name">Cash Book & Calculator</h4>
                            <p itemprop="description">Daily Cash Book with Denomination Counter. Fast Money Calculation & Tally.</p>
                            <meta itemprop="position" content="2">
                        </div>
                        <div class="feature-poster" itemscope itemtype="https://schema.org/ListItem" tabindex="0" aria-label="Party Ledger Feature">
                            <span class="feature-icon-lg" aria-hidden="true">&#128202;</span>
                            <h4 itemprop="name">Party Ledger & Bill Book</h4>
                            <p itemprop="description">Manage Customer Udhar Hisab, Credit/Debit Accounts & Business Bills.</p>
                            <meta itemprop="position" content="3">
                        </div>
                        <div class="feature-poster" itemscope itemtype="https://schema.org/ListItem" tabindex="0" aria-label="Security Feature">
                            <span class="feature-icon-lg" aria-hidden="true">&#128274;</span>
                            <h4 itemprop="name">Secure PIN & Encryption</h4>
                            <p itemprop="description">AES-256 Encrypted Business Data. PIN Lock Protection. 100% Private.</p>
                            <meta itemprop="position" content="4">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="app.switchTab('entry')" style="margin-top: 1rem; font-size: 1.1rem; padding: 1rem;" aria-label="Start New Entry">
                        <span aria-hidden="true">&#10133;</span> Start New Entry
                    </button>

                    <div class="home-credits">
                        <h3>ArthaNex v2.3.0</h3>
                        <p>Author: Pintu Sikder</p>
                        <p>By: <a href="https://github.com/Pintusikder" target="_blank" rel="noopener noreferrer">Arthixa</a></p>
                    </div>
                </div>
            </section>

            <!-- SECTION1: CASH ENTRY -->
            <section id="entry" class="view" aria-label="New Entry">
                <div class="card">
                    <div class="form-group">
                        <label for="countryDropdown">Country & Currency</label>
                        <div class="custom-select-wrapper">
                            <div class="custom-select" id="countryDropdown" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-label="Select Country and Currency">
                                <div class="custom-select__trigger" tabindex="0" aria-label="Select Country"><span>Select Country</span><div class="arrow" aria-hidden="true"></div></div>
                                <div class="custom-select__options" role="listbox">
                                    <div class="custom-select__search">
                                        <input type="text" placeholder="Ex: India, USD, Euro..." id="countrySearchInput" aria-label="Search country or currency">
                                    </div>
                                    <div style="padding: 0 10px 10px 10px; font-size: 0.75rem; color: var(--neutral); font-style: italic;">
                                        Try typing country name (e.g., "India") or Currency Code (e.g., "USD").
                                    </div>
                                    <div class="options-container" id="countryOptionsList" role="listbox"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="display: flex; gap: 10px;">
                        <div style="flex:1">
                            <label for="entryDate">Date</label>
                            <input type="date" id="entryDate" class="form-control" aria-required="true">
                        </div>
                        <div style="flex:1">
                            <label for="entryTime">Time</label>
                            <input type="time" id="entryTime" class="form-control" aria-required="true">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="entryName">Collected By (Name) <span aria-label="required">*</span></label>
                        <input type="text" id="entryName" class="form-control" placeholder="Enter Name (Required)" aria-required="true" autocomplete="name">
                    </div>

                    <div class="form-group">
                        <label for="entryMobile">Mobile Number</label>
                        <input type="tel" id="entryMobile" class="form-control" placeholder="Optional" autocomplete="tel" pattern="[0-9]*" inputmode="numeric">
                    </div>

                    <div class="form-group">
                        <label for="tagInput">Optional Items (Tags)</label>
                        <div class="tags-input-group">
                            <input type="text" id="tagInput" class="form-control" placeholder="Add item (e.g. Rent)" aria-label="Add tag">
                            <button class="btn btn-primary" style="width: auto;" onclick="app.addTag()" aria-label="Add Tag">Add</button>
                        </div>
                        <div id="tagsContainer" class="tags-container" aria-live="polite"></div>
                    </div>

                    <div class="form-group">
                        <label for="entryRemarks">Remarks / Notes</label>
                        <input type="text" id="entryRemarks" class="form-control" placeholder="Optional notes..." aria-label="Remarks or notes">
                    </div>

                    <div class="form-group">
                        <label for="entryStatus">Payment Status</label>
                        <select id="entryStatus" class="form-control" onchange="app.handleStatusChange()" aria-label="Payment Status">
                            <option value="Paid">Paid (Cleared)</option>
                            <option value="Due">Due (Outstanding)</option>
                            <option value="Partial">Partial Payment</option>
                        </select>
                    </div>

                    <div class="form-group" id="paidOptions">
                        <div class="checkbox-wrapper" onclick="app.togglePayable()">
                            <input type="checkbox" id="entryPayable" aria-label="Payable to Customer">
                            <label for="entryPayable">Payable to Customer (Cash Out)</label>
                        </div>
                    </div>

                    <div class="form-group" id="dueOptions" style="display: none;">
                        <label>Due Type (Who owes whom?)</label>
                        <div class="radio-group" role="radiogroup" aria-label="Due Type">
                            <label>
                                <input type="radio" name="dueType" value="receivable" checked aria-label="Customer will pay">
                                Receivable (Customer will pay)
                            </label>
                            <label>
                                <input type="radio" name="dueType" value="payable" aria-label="I have to pay">
                                Payable (I have to pay)
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="partialOptions" style="display:none; margin-top:12px;">
                        <label style="margin-bottom:8px; display:block;">Amount Summary</label>
                        <input type="number" id="partialTotalAmount" class="form-control" style="margin-bottom:10px;" placeholder="Total Bill Amount" oninput="app.calculatePartial()" aria-label="Total Bill Amount">
                        <input type="number" id="partialCollectedAmount" class="form-control" style="margin-bottom:10px;" placeholder="Amount Received" oninput="app.calculatePartial()" aria-label="Amount Received">
                        <input type="number" id="partialBalanceAmount" class="form-control" style="margin-bottom:12px;" placeholder="Balance Due" readonly aria-label="Balance Due">
                        <label style="margin-bottom:6px; display:block;">Outstanding Type (Who owes whom?)</label>
                        <div class="radio-group" style="margin-top:6px;" role="radiogroup" aria-label="Outstanding Type">
                            <label style="display:block; margin-bottom:6px;">
                                <input type="radio" name="partialDueType" value="receivable" checked aria-label="Customer will pay balance">
                                Receivable (Customer will pay)
                            </label>
                            <label style="display:block;">
                                <input type="radio" name="partialDueType" value="payable" aria-label="I have to pay balance">
                                Payable (I have to pay)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <label style="font-weight: 600; color: var(--neutral);">Denomination Counter</label>
                    <div id="denominationContainer" class="denom-grid" role="group" aria-label="Denomination Counter"></div>
                </div>

                <div class="total-display" role="status" aria-live="polite" aria-label="Total Amount Display">
                    <div class="total-label">Total Amount</div>
                    <div class="total-amount" id="displayTotal">0.00</div>
                    <div class="total-words" id="displayWords">Select a country to begin</div>
                </div>

                <div style="margin-bottom: 80px;">
                    <button class="btn btn-primary" onclick="app.saveRecord()" aria-label="Save Record">
                        <span aria-hidden="true">&#128190;</span> Save Record
                    </button>
                </div>
            </section>

            <!-- SECTION 2: HISTORY -->
            <section id="history" class="view" aria-label="Transaction History">
                <div class="card">
                    <div class="filter-container">
                        <div class="filter-tabs" role="radiogroup" aria-label="Filter Type">
                            <input type="radio" id="filter-name" name="filterType" value="name" onchange="app.setFilterMode('name')" checked aria-label="Filter by Name">
                            <label for="filter-name">Name</label>
                            <input type="radio" id="filter-date" name="filterType" value="date" onchange="app.setFilterMode('date')" aria-label="Filter by Date">
                            <label for="filter-date">Date</label>
                            <input type="radio" id="filter-amount" name="filterType" value="amount" onchange="app.setFilterMode('amount')" aria-label="Filter by Amount">
                            <label for="filter-amount">Amount</label>
                        </div>

                        <div class="filter-input-wrapper">
                            <input type="text" id="filterName" class="filter-input" placeholder="Search by Name (e.g. Rahul)..." onkeyup="app.handleFilter('name', this.value)" aria-label="Search by name">
                            <input type="date" id="filterDate" class="filter-input" style="display:none;" onchange="app.handleFilter('date', this.value)" aria-label="Search by date">
                            <input type="number" id="filterAmount" class="filter-input" placeholder="Enter Amount..." style="display:none;" onkeyup="app.handleFilter('amount', this.value)" aria-label="Search by amount">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-secondary" style="flex:1" onclick="app.exportLast30Days()" aria-label="Export Last 30 Days">Export (30 Days)</button>
                        <button class="btn btn-outline" style="flex:1" onclick="app.openRangeModal()" aria-label="Export Date Range">Date Range</button>
                    </div>
                </div>

                <ul id="historyList" class="history-list" role="list" aria-label="Transaction History"></ul>
                <div id="emptyState" class="text-center" style="padding: 2rem; display: none;" role="status" aria-live="polite">
                    <p style="color: var(--neutral);">No records found.</p>
                </div>
            </section>

            <!-- SECTION 3: OUTSTANDING / DUES -->
            <section id="outstanding" class="view" aria-label="Outstanding Dues">
                <div class="card">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">Outstanding Summary</h3>
                    <div class="dashboard-container" style="margin-bottom: 10px; padding:0; border:none; background:transparent; grid-template-columns: 1fr 1fr;">
                        <div class="stat-card" role="status" aria-label="Amount to Receive">
                            <div class="stat-label">To Receive</div>
                            <div class="stat-val" style="color:var(--text-income)" id="dueReceivable" aria-live="polite">0</div>
                        </div>
                        <div class="stat-card" role="status" aria-label="Amount to Pay">
                            <div class="stat-label">To Pay</div>
                            <div class="stat-val" style="color:var(--text-expense)" id="duePayable" aria-live="polite">0</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 10px; display:flex; gap:10px;">
                    <button class="btn btn-outline" onclick="app.renderOutstanding('all')" aria-label="Show All Dues">All</button>
                    <button class="btn btn-outline" style="border-color:var(--text-income); color:var(--text-income)" onclick="app.renderOutstanding('receivable')" aria-label="Show Receivables">Receivable</button>
                    <button class="btn btn-outline" style="border-color:var(--text-expense); color:var(--text-expense)" onclick="app.renderOutstanding('payable')" aria-label="Show Payables">Payable</button>
                </div>

                <ul id="outstandingList" class="history-list" role="list" aria-label="Outstanding Dues List"></ul>
                <div id="outstandingEmpty" class="text-center" style="padding: 2rem; display: none;" role="status" aria-live="polite">
                    <p style="color: var(--neutral);">No outstanding dues.</p>
                </div>
            </section>

            <!-- SECTION 4: PARTY LEDGER -->
            <section id="ledger" class="view" aria-label="Party Ledger">
                <div class="card">
                    <label for="ledgerSearch">Search Customer / Party</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="ledgerSearch" class="form-control" placeholder="Ex: Rahul, Priya..." oninput="app.suggestLedgerName(this.value)" aria-label="Search customer or party">
                    </div>
                    <div id="ledgerSuggestions" style="margin-top:5px; display:flex; flex-wrap:wrap; gap:5px;"></div>
                    <div class="search-hint">Type customer name to see their ledger.</div>
                </div>

                <div id="ledgerDetails" style="display:none;">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 id="ledgerCustomerName" style="color:var(--primary); margin:0; word-break: break-word;">Customer Name</h3>
                            <button class="btn btn-outline" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="app.clearLedger()" aria-label="Clear Ledger">Clear</button>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                            <div style="background:var(--bg-income); padding:10px; border-radius:var(--radius-sm); text-align:center;" role="status" aria-label="Total Received">
                                <div style="font-size:0.7rem; text-transform:uppercase;">Total Received</div>
                                <div style="font-size:1.1rem; font-weight:bold; color:var(--text-income);" id="ledgerTotalReceived" aria-live="polite">0</div>
                            </div>
                            <div style="background:var(--bg-expense); padding:10px; border-radius:var(--radius-sm); text-align:center;" role="status" aria-label="Total Paid">
                                <div style="font-size:0.7rem; text-transform:uppercase;">Total Paid/Given</div>
                                <div style="font-size:1.1rem; font-weight:bold; color:var(--text-expense);" id="ledgerTotalPaid" aria-live="polite">0</div>
                            </div>
                        </div>

                        <div style="margin-top:10px; padding:10px; background:var(--bg-balance); border-radius:var(--radius-sm); text-align:center;" role="status" aria-label="Net Balance">
                            <div style="font-size:0.7rem; text-transform:uppercase;">Net Balance</div>
                            <div style="font-size:1.2rem; font-weight:bold; color:var(--text-balance);" id="ledgerNetBalance" aria-live="polite">0</div>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 10px 5px; font-size:1rem; color:var(--neutral);">Transactions</h4>
                    <ul id="ledgerList" class="history-list" role="list" aria-label="Customer Transactions"></ul>
                </div>
                <div id="ledgerEmpty" class="text-center" style="padding: 2rem; margin-top:20px; display: block;" role="status" aria-live="polite">
                    <p style="color: var(--neutral);">Select a customer to view ledger.</p>
                </div>
            </section>
        </main>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal" role="dialog" aria-labelledby="settingsTitle" aria-modal="true">
            <div class="modal-content">
                <button class="modal-close" onclick="app.toggleModal('settingsModal')" aria-label="Close Settings">&times;</button>
                <h2 id="settingsTitle" style="margin-bottom: 1.5rem; color: var(--primary);">Settings</h2>
                <div class="form-group">
                    <label for="themeSelect">Theme</label>
                    <select id="themeSelect" class="form-control" onchange="app.setTheme(this.value)" aria-label="Select Theme">
                        <option value="light">Light Mode</option>
                        <option value="dark">Dark Mode</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="primaryColorInput">App Theme Color</label>
                    <input type="color" id="primaryColorInput" class="form-control" style="height: 50px; padding:5px;" onchange="app.setPrimaryColor(this.value)" aria-label="Select Primary Color">
                    <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: flex-start;">
                        <div onclick="app.setPrimaryColor('#F67B34')" style="width: 35px; height: 35px; border-radius: 50%; background-color: #F67B34; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);" title="Default Orange" tabindex="0" role="button" aria-label="Select Orange Theme"></div>
                        <div onclick="app.setPrimaryColor('#FF0000')" style="width: 35px; height: 35px; border-radius: 50%; background-color: #FF0000; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);" title="Deep Orange" tabindex="0" role="button" aria-label="Select Red Theme"></div>
                        <div onclick="app.setPrimaryColor('#007bff')" style="width: 35px; height: 35px; border-radius: 50%; background-color: #007bff; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);" title="Blue" tabindex="0" role="button" aria-label="Select Blue Theme"></div>
                        <div onclick="app.setPrimaryColor('#28a745')" style="width: 35px; height: 35px; border-radius: 50%; background-color: #28a745; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);" title="Green" tabindex="0" role="button" aria-label="Select Green Theme"></div>
                        <div onclick="app.setPrimaryColor('#6f42c1')" style="width: 35px; height: 35px; border-radius: 50%; background-color: #6f42c1; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);" title="Purple" tabindex="0" role="button" aria-label="Select Purple Theme"></div>
                        <div onclick="app.setPrimaryColor('#e83e8c')" style="width: 35px; height: 35px; border-radius: 50%; background-color: #e83e8c; cursor: pointer; border: 2px solid rgba(0,0,0,0.1);" title="Pink" tabindex="0" role="button" aria-label="Select Pink Theme"></div>
                    </div>
                </div>

                <!-- PROFILE MANAGEMENT SECTION -->
                <div class="card" style="margin-bottom: 1rem; border: 1px dashed var(--primary); background: rgba(243, 108, 33, 0.05);">
                    <label style="font-weight: 700; color: var(--primary); margin-bottom: 10px;">Manage Business Profiles</label>
                    <div class="form-group" style="margin-bottom: 5px;">
                        <input type="text" id="newProfileName" class="form-control" placeholder="New Shop/Business Name" aria-label="New Profile Name">
                        <button class="btn btn-primary btn-sm" style="margin-top:5px;" onclick="app.createProfile()" aria-label="Create New Profile">Create New Profile</button>
                    </div>
                    <ul id="profileListContainer" class="profile-list" role="list" aria-label="Profile List"></ul>
                </div>

                <div class="form-group">
                    <label>Country & Currency</label>
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="settingsCountryDropdown" role="combobox" aria-expanded="false" aria-haspopup="listbox" aria-label="Select Country in Settings">
                            <div class="custom-select__trigger" tabindex="0" aria-label="Select Country"><span>Select Country</span><div class="arrow" aria-hidden="true"></div></div>
                            <div class="custom-select__options" role="listbox">
                                <div class="custom-select__search">
                                    <input type="text" placeholder="Ex: India, USD, Euro..." id="settingsSearchInput" aria-label="Search country or currency">
                                </div>
                                <div style="padding: 0 10px 10px 10px; font-size: 0.75rem; color: var(--neutral); font-style: italic;">
                                    Try typing country name or Currency Code.
                                </div>
                                <div class="options-container" id="settingsOptionsList" role="listbox"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-wrapper" style="display: flex; align-items: center; gap: 10px; padding: 5px 0; border: none; background: transparent;" onclick="app.toggleAutoDelete()">
                        <input type="checkbox" id="autoDeleteToggle" style="cursor: pointer;" aria-label="Auto-delete records older than 90 days">
                        <label for="autoDeleteToggle" style="cursor: pointer; width: auto;">Auto-delete records older than 90 days</label>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--neutral); margin-top: 5px; margin-left: 24px;">When enabled, records older than 90 days are automatically deleted on app reload.</div>
                </div>

                <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border);">
                <button class="btn btn-outline" onclick="showUserGuide()" style="margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;" aria-label="Open User Guide">
                    <span aria-hidden="true">&#128214;</span>
                    <span>User Guide</span>
                </button>
                <div class="credits-container">
                    <h3>ArthaNex</h3>
                    <p>Version 2.3.0</p>
                    <p>Author: Pintu Sikder</p>
                    <p>By: <a href="https://github.com/Pintusikder" target="_blank" rel="noopener noreferrer" class="By-link">Arthixa</a></p>
                </div>
            </div>
        </div>

        <!-- Date Range Modal -->
        <div id="dateRangeModal" class="modal" role="dialog" aria-labelledby="dateRangeTitle" aria-modal="true">
            <div class="modal-content">
                <button class="modal-close" onclick="app.toggleModal('dateRangeModal')" aria-label="Close Date Range">&times;</button>
                <h2 id="dateRangeTitle" style="margin-bottom: 1.5rem; color: var(--primary);">Select Date Range</h2>
                <div class="form-group">
                    <label for="rangeStart">From Date</label>
                    <input type="date" id="rangeStart" class="form-control" aria-required="true">
                </div>
                <div class="form-group">
                    <label for="rangeEnd">To Date</label>
                    <input type="date" id="rangeEnd" class="form-control" aria-required="true">
                </div>
                <button class="btn btn-primary" onclick="app.generateRangeReport()" aria-label="Export Date Range">Export Range</button>
            </div>
        </div>

        <!-- View Details Modal -->
        <div id="viewDetailModal" class="modal" role="dialog" aria-labelledby="detailsTitle" aria-modal="true">
            <div class="modal-content">
                <button class="modal-close" onclick="app.toggleModal('viewDetailModal')" aria-label="Close Details">&times;</button>
                <h2 id="detailsTitle" style="margin-bottom: 1rem; color: var(--primary);">Record Details</h2>
                <div id="detailContent"></div>
            </div>
        </div>

        <!-- PRINTABLE AREA -->
        <div id="print-area" aria-hidden="true"></div>

        <div id="toast" role="status" aria-live="polite" aria-atomic="true">Message here</div>

        <!-- PWA INSTALL BANNER -->
        <div id="pwa-install-banner" role="banner" aria-label="Install App Banner">
            <div class="pwa-content">
                <div class="pwa-title">Install as App</div>
                <div class="pwa-desc">Add to Home Screen for quick access</div>
            </div>
            <button id="installBtn" class="btn-install" aria-label="Install App">Install</button>
            <button id="closePrompt" class="btn-close-pwa" aria-label="Close Install Banner">&times;</button>
        </div>
    </div>

    <!-- PWA Install Prompt Logic -->
    <script>
        let deferredPrompt;
        const installBanner = document.getElementById('pwa-install-banner');
        const installBtn = document.getElementById('installBtn');
        const closePrompt = document.getElementById('closePrompt');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBanner.style.display = 'flex';
        });

        installBtn.addEventListener('click', () => {
            installBanner.style.display = 'none';
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                });
            }
        });

        closePrompt.addEventListener('click', () => {
            installBanner.style.display = 'none';
            deferredPrompt = null;
        });
    </script>


    <!-- Main App Logic -->
    <script>
        // App Logic
        const app = {
            state: {
                currentTheme: 'light',
                primaryColor: '#F67B34',
                autoDeleteEnabled: false,
                currentTags: [],
                profiles: [{ id: 1, name: "My Business" }],
                currentProfileId: 1,
                config: [
                    { name: "United States", currency: "USD", symbol: "$", flag: "&#127482;&#127480;", denominations: [1, 2, 5, 10, 20, 50, 100] },
                    { name: "India", currency: "INR", symbol: "&#8377;", flag: "&#127470;&#127475;", denominations: [1, 2, 5, 10, 20, 50, 100, 200, 500] },
                    { name: "Euro Zone", currency: "EUR", symbol: "&#8364;", flag: "&#127466;&#127482;", denominations: [5, 10, 20, 50, 100, 200, 500] },
                    { name: "United Kingdom", currency: "GBP", symbol: "&#163;", flag: "&#127468;&#127463;", denominations: [5, 10, 20, 50] },
                    { name: "Japan", currency: "JPY", symbol: "&#165;", flag: "&#127471;&#127477;", denominations: [1, 5, 10, 50, 100, 500, 1000, 5000, 10000] },
                    { name: "Australia", currency: "AUD", symbol: "A$", flag: "&#127462;&#127482;", denominations: [5, 10, 20, 50, 100] },
                    { name: "Canada", currency: "CAD", symbol: "C$", flag: "&#127464;&#127462;", denominations: [5, 10, 20, 50, 100] },
                    { name: "China", currency: "CNY", symbol: "&#165;", flag: "&#127464;&#127475;", denominations: [1, 5, 10, 20, 50, 100] },
                    { name: "Switzerland", currency: "CHF", symbol: "Fr", flag: "&#127464;&#127469;", denominations: [10, 20, 50, 100, 200, 1000] },
                    { name: "Russia", currency: "RUB", symbol: "&#8381;", flag: "&#127479;&#127482;", denominations: [50, 100, 200, 500, 1000, 2000, 5000] },
                    { name: "South Korea", currency: "KRW", symbol: "&#8361;", flag: "&#127472;&#127479;", denominations: [1000, 5000, 10000, 50000] },
                    { name: "Brazil", currency: "BRL", symbol: "R$", flag: "&#127463;&#127479;", denominations: [10, 20, 50, 100, 200] },
                    { name: "Mexico", currency: "MXN", symbol: "$", flag: "&#127474;&#127485;", denominations: [20, 50, 100, 200, 500] },
                    { name: "South Africa", currency: "ZAR", symbol: "R", flag: "&#127487;&#127462;", denominations: [10, 20, 50, 100, 200] },
                    { name: "Singapore", currency: "SGD", symbol: "S$", flag: "&#127480;&#127468;", denominations: [2, 5, 10, 50, 100, 1000] },
                    { name: "Hong Kong", currency: "HKD", symbol: "HK$", flag: "&#127469;&#127472;", denominations: [10, 20, 50, 100, 500, 1000] },
                    { name: "New Zealand", currency: "NZD", symbol: "NZ$", flag: "&#127475;&#127487;", denominations: [5, 10, 20, 50, 100] },
                    { name: "Sweden", currency: "SEK", symbol: "kr", flag: "&#127480;&#127466;", denominations: [20, 50, 100, 200, 500] },
                    { name: "Norway", currency: "NOK", symbol: "kr", flag: "&#127475;&#127476;", denominations: [50, 100, 200, 500, 1000] },
                    { name: "Denmark", currency: "DKK", symbol: "kr", flag: "&#127465;&#127472;", denominations: [50, 100, 200, 500, 1000] },
                    { name: "Poland", currency: "PLN", symbol: "z&#322;", flag: "&#127477;&#127473;", denominations: [10, 20, 50, 100, 200, 500] },
                    { name: "Turkey", currency: "TRY", symbol: "&#8378;", flag: "&#127481;&#127479;", denominations: [20, 50, 100, 200, 500] },
                    { name: "Thailand", currency: "THB", symbol: "&#3647;", flag: "&#127481;&#127469;", denominations: [20, 50, 100, 500, 1000] },
                    { name: "Malaysia", currency: "MYR", symbol: "RM", flag: "&#127474;&#127486;", denominations: [1, 5, 10, 20, 50, 100] },
                    { name: "Indonesia", currency: "IDR", symbol: "Rp", flag: "&#127470;&#127465;", denominations: [1000, 2000, 5000, 10000, 20000, 50000, 100000] },
                    { name: "Philippines", currency: "PHP", symbol: "&#8369;", flag: "&#127477;&#127469;", denominations: [20, 50, 100, 200, 500, 1000] },
                    { name: "Vietnam", currency: "VND", symbol: "&#8363;", flag: "&#127483;&#127475;", denominations: [1000, 2000, 5000, 10000, 20000, 50000, 100000, 200000, 500000] },
                    { name: "UAE", currency: "AED", symbol: "dh", flag: "&#127462;&#127466;", denominations: [5, 10, 20, 50, 100, 200, 500, 1000] },
                    { name: "Saudi Arabia", currency: "SAR", symbol: "&#65020;", flag: "&#127480;&#127462;", denominations: [1, 5, 10, 50, 100, 200, 500] },
                    { name: "Israel", currency: "ILS", symbol: "&#8362;", flag: "&#127470;&#127473;", denominations: [20, 50, 100, 200] },
                    { name: "Czech Republic", currency: "CZK", symbol: "K&#269;", flag: "&#127464;&#127487;", denominations: [100, 200, 500, 1000, 2000, 5000] },
                    { name: "Hungary", currency: "HUF", symbol: "Ft", flag: "&#127469;&#127482;", denominations: [500, 1000, 2000, 5000, 10000, 20000] },
                    { name: "Romania", currency: "RON", symbol: "lei", flag: "&#127479;&#127476;", denominations: [1, 5, 10, 20, 50, 100, 200, 500] },
                    { name: "Bulgaria", currency: "BGN", symbol: "&#1083;&#1074;", flag: "&#127463;&#127468;", denominations: [10, 20, 50, 100] },
                    { name: "Croatia", currency: "EUR", symbol: "&#8364;", flag: "&#127469;&#127472;", denominations: [5, 10, 20, 50, 100, 200, 500] },
                    { name: "Nigeria", currency: "NGN", symbol: "&#8358;", flag: "&#127475;&#127468;", denominations: [5, 10, 20, 50, 100, 200, 500, 1000] },
                    { name: "Egypt", currency: "EGP", symbol: "E&#163;", flag: "&#127466;&#127468;", denominations: [10, 20, 50, 100, 200, 500] },
                    { name: "Pakistan", currency: "PKR", symbol: "&#8360;", flag: "&#127477;&#127472;", denominations: [10, 20, 50, 100, 500, 1000, 5000] },
                    { name: "Bangladesh", currency: "BDT", symbol: "&#2547;", flag: "&#127463;&#127465;", denominations: [10, 20, 50, 100, 200, 500, 1000] },
                    { name: "Sri Lanka", currency: "LKR", symbol: "Rs", flag: "&#127473;&#127472;", denominations: [20, 50, 100, 200, 500, 1000, 2000, 5000] },
                    { name: "Nepal", currency: "NPR", symbol: "&#8360;", flag: "&#127475;&#127477;", denominations: [5, 10, 20, 50, 100, 500, 1000] },
                    { name: "Myanmar", currency: "MMK", symbol: "K", flag: "&#127474;&#127474;", denominations: [50, 100, 200, 500, 1000, 5000, 10000] },
                    { name: "Argentina", currency: "ARS", symbol: "$", flag: "&#127462;&#127479;", denominations: [100, 200, 500, 1000, 2000, 5000, 10000] },
                    { name: "Chile", currency: "CLP", symbol: "$", flag: "&#127464;&#127473;", denominations: [1000, 2000, 5000, 10000, 20000] },
                    { name: "Colombia", currency: "COP", symbol: "$", flag: "&#127464;&#127476;", denominations: [2000, 5000, 10000, 20000, 50000, 100000] },
                    { name: "Peru", currency: "PEN", symbol: "S/", flag: "&#127477;&#127466;", denominations: [10, 20, 50, 100, 200] },
                    { name: "Venezuela", currency: "VES", symbol: "Bs.", flag: "&#127483;&#127466;", denominations: [5, 10, 20, 50, 100] },
                    { name: "Iraq", currency: "IQD", symbol: "&#1593;.&#1583;", flag: "&#127470;&#127478;", denominations: [250, 500, 1000, 5000, 10000, 25000] },
                    { name: "Kuwait", currency: "KWD", symbol: "&#1583;.&#1603;", flag: "&#127472;&#127484;", denominations: [0.25, 0.5, 1, 5, 10, 20] }
                ],
                selectedCountry: null,
                records: [],
                denominations: {},
                filters: { mode: 'name', name: "", date: "", amount: "" }
            },

            init: function() {
                try {
                    this.loadSettings();
                    this.loadProfiles();
                    this.setupDropdowns();
                    this.loadRecords();
                    this.cleanupOldRecords();
                    this.migrateRecordsToProfile();

                    const savedCountryName = localStorage.getItem('arthaNex_lastCountry');
                    if (savedCountryName) {
                        const savedCountry = this.state.config.find(c => c.name === savedCountryName);
                        if (savedCountry) {
                            this.selectCountry(savedCountry);
                        }
                    }

                    this.updateDashboard();
                    this.updateHeaderProfileDisplay();
                    this.renderProfileList();

                    const now = new Date();
                    document.getElementById('entryDate').valueAsDate = now;
                    document.getElementById('entryTime').value = now.toTimeString().substring(0,5);

                    const todayStr = now.toISOString().split('T')[0];
                    document.getElementById('entryDate').max = todayStr;
                    document.getElementById('filterDate').max = todayStr;
                    document.getElementById('rangeStart').max = todayStr;
                    document.getElementById('rangeEnd').max = todayStr;

                    document.getElementById('settingsBtn').addEventListener('click', () => this.toggleModal('settingsModal'));

                    window.addEventListener('click', (e) => {
                        if (!e.target.closest('.menu-container')) this.closeAllMenus();
                        if (e.target.classList.contains('modal')) e.target.classList.remove('open');
                    });

                    this.switchTab('home');
                } catch (error) {
                    this.showToast('Error initializing app. Please refresh.');
                }
            },

            // Unified dropdown setup - removes duplicate code
            setupDropdowns: function() {
                this.setupDropdown('countryDropdown', 'countrySearchInput', 'countryOptionsList');
                this.setupDropdown('settingsCountryDropdown', 'settingsSearchInput', 'settingsOptionsList');
            },

            setupDropdown: function(dropdownId, searchInputId, optionsListId) {
                const wrapper = document.getElementById(dropdownId);
                if (!wrapper) return;

                const trigger = wrapper.querySelector('.custom-select__trigger');
                const searchInput = document.getElementById(searchInputId);

                this.populateOptions(this.state.config, optionsListId);

                trigger.addEventListener('click', (e) => {
                    wrapper.classList.toggle('open');
                    const isOpen = wrapper.classList.contains('open');
                    wrapper.setAttribute('aria-expanded', isOpen);
                    if (isOpen) {
                        searchInput.value = '';
                        searchInput.focus();
                        this.populateOptions(this.state.config, optionsListId);
                    }
                });

                trigger.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        trigger.click();
                    }
                });

                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = this.state.config.filter(c => {
                        const countryMatch = c.name.toLowerCase().includes(term);
                        const currencyMatch = c.currency.toLowerCase().includes(term);
                        return countryMatch || currencyMatch;
                    });
                    this.populateOptions(filtered, optionsListId);
                });

                window.addEventListener('click', (e) => {
                    if (!wrapper.contains(e.target)) {
                        wrapper.classList.remove('open');
                        wrapper.setAttribute('aria-expanded', 'false');
                    }
                });
            },

            populateOptions: function(list, targetId) {
                const container = document.getElementById(targetId);
                if (!container) return;

                container.innerHTML = '';
                if (list.length === 0) {
                    container.innerHTML = '<div class="custom-option" style="cursor:default; color:var(--neutral)">No match found</div>';
                    return;
                }

                list.forEach((c, index) => {
                    const el = document.createElement('span');
                    el.className = 'custom-option';
                    el.setAttribute('role', 'option');
                    el.setAttribute('tabindex', '0');
                    if (this.state.selectedCountry && this.state.selectedCountry.name === c.name) {
                        el.classList.add('selected');
                        el.setAttribute('aria-selected', 'true');
                    } else {
                        el.setAttribute('aria-selected', 'false');
                    }
                    el.innerHTML = `${c.flag} ${c.name} (${c.currency})`;

                    const selectHandler = () => {
                        this.selectCountry(c);
                        if (document.getElementById('settingsModal').classList.contains('open')) {
                            this.toggleModal('settingsModal');
                        }
                        document.querySelectorAll('.custom-select').forEach(s => {
                            s.classList.remove('open');
                            s.setAttribute('aria-expanded', 'false');
                        });
                    };

                    el.addEventListener('click', selectHandler);
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            selectHandler();
                        }
                    });
                    container.appendChild(el);
                });
            },

            selectCountry: function(country) {
                this.state.selectedCountry = country;
                const entryTrigger = document.querySelector('#countryDropdown .custom-select__trigger span');
                if (entryTrigger) entryTrigger.innerHTML = `${country.flag} ${country.name} (${country.currency})`;
                const settingsTrigger = document.querySelector('#settingsCountryDropdown .custom-select__trigger span');
                if (settingsTrigger) settingsTrigger.innerHTML = `${country.flag} ${country.name} (${country.currency})`;
                localStorage.setItem('arthaNex_lastCountry', country.name);
                document.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                this.loadDenominations();
            },

            // PROFILE FUNCTIONS
            loadProfiles: function() {
                try {
                    const savedProfiles = localStorage.getItem('arthaNex_profiles');
                    if (savedProfiles) {
                        this.state.profiles = JSON.parse(savedProfiles);
                    }
                    const savedProfileId = localStorage.getItem('arthaNex_currentProfileId');
                    if (savedProfileId) {
                        this.state.currentProfileId = parseInt(savedProfileId);
                    }
                } catch (error) {
                    this.state.profiles = [{ id: 1, name: "My Business" }];
                    this.state.currentProfileId = 1;
                }
            },

            saveProfiles: function() {
                try {
                    localStorage.setItem('arthaNex_profiles', JSON.stringify(this.state.profiles));
                    localStorage.setItem('arthaNex_currentProfileId', this.state.currentProfileId);
                    this.renderProfileList();
                    this.updateHeaderProfileDisplay();
                } catch (error) {
                    this.showToast('Error saving profiles');
                }
            },

            createProfile: function() {
                const input = document.getElementById('newProfileName');
                const name = input.value.trim();
                if (!name) {
                    this.showToast("Please enter a profile name.");
                    return;
                }
                const newId = Date.now();
                this.state.profiles.push({ id: newId, name: name });
                this.state.currentProfileId = newId;
                this.saveProfiles();
                input.value = "";
                this.showToast("New Profile Created!");
                this.updateDashboard();
                this.renderHistory();
                this.renderOutstanding('all');
            },

            switchProfile: function(id) {
                this.state.currentProfileId = id;
                this.saveProfiles();
                this.updateDashboard();
                this.renderHistory();
                this.renderOutstanding('all');
                this.clearLedger();
                const profile = this.state.profiles.find(p => p.id === id);
                this.showToast("Switched to " + (profile ? profile.name : 'Unknown'));
            },

            deleteProfile: function(id, event) {
                event.stopPropagation();
                if (this.state.profiles.length <= 1) {
                    this.showToast("You must have at least one profile.");
                    return;
                }
                if (confirm("Are you sure? All records in this profile will be deleted.")) {
                    this.state.records = this.state.records.filter(r => r.profileId !== id);
                    localStorage.setItem('arthaNex_records', JSON.stringify(this.state.records));
                    this.state.profiles = this.state.profiles.filter(p => p.id !== id);
                    if (this.state.currentProfileId === id) {
                        this.state.currentProfileId = this.state.profiles[0].id;
                    }
                    this.saveProfiles();
                    this.updateDashboard();
                    this.renderHistory();
                    this.renderOutstanding('all');
                    this.showToast("Profile deleted.");
                }
            },

            renderProfileList: function() {
                const container = document.getElementById('profileListContainer');
                if (!container) return;
                container.innerHTML = '';
                this.state.profiles.forEach(p => {
                    const li = document.createElement('li');
                    li.className = `profile-item ${p.id === this.state.currentProfileId ? 'active' : ''}`;
                    let deleteBtn = '';
                    if (this.state.profiles.length > 1) {
                        deleteBtn = `<button class="profile-btn btn-delete" onclick="app.deleteProfile(${p.id}, event)" aria-label="Delete ${p.name} profile">Delete</button>`;
                    }
                    li.innerHTML = `
                        <span class="profile-name">${p.name}</span>
                        <div class="profile-actions">
                            ${p.id !== this.state.currentProfileId ? `<button class="profile-btn btn-switch" onclick="app.switchProfile(${p.id})" aria-label="Switch to ${p.name}">Switch</button>` : '<span class="profile-btn" style="background:#ccc; color:#555; cursor:default;">Active</span>'}
                            ${deleteBtn}
                        </div>
                    `;
                    container.appendChild(li);
                });
            },

            updateHeaderProfileDisplay: function() {
                const profile = this.state.profiles.find(p => p.id === this.state.currentProfileId);
                const element = document.getElementById('headerProfileName');
                if (profile && element) {
                    element.textContent = profile.name;
                }
            },

            getProfileRecords: function() {
                return this.state.records.filter(r => r.profileId === this.state.currentProfileId);
            },

            migrateRecordsToProfile: function() {
                const needsMigration = this.state.records.some(r => !r.profileId);
                if (needsMigration) {
                    this.state.records.forEach(r => {
                        if (!r.profileId) {
                            r.profileId = this.state.currentProfileId;
                        }
                    });
                    localStorage.setItem('arthaNex_records', JSON.stringify(this.state.records));
                }
            },

            setPrimaryColor: function(color) {
                this.state.primaryColor = color;
                document.documentElement.style.setProperty('--primary', color);
                document.documentElement.style.setProperty('--accent', color);
                document.documentElement.style.setProperty('--primary-hover', color);
                const themeMeta = document.querySelector('meta[name="theme-color"]');
                if (themeMeta) themeMeta.setAttribute("content", color);
                localStorage.setItem('arthaNex_primaryColor', color);
                const colorInput = document.getElementById('primaryColorInput');
                if (colorInput) colorInput.value = color;
            },

            addTag: function() {
                const input = document.getElementById('tagInput');
                const val = input.value.trim();
                if (val && !this.state.currentTags.includes(val)) {
                    this.state.currentTags.push(val);
                    input.value = '';
                    this.renderTags();
                }
            },

            removeTag: function(tag) {
                this.state.currentTags = this.state.currentTags.filter(t => t !== tag);
                this.renderTags();
            },

            renderTags: function() {
                const container = document.getElementById('tagsContainer');
                if (!container) return;
                container.innerHTML = '';
                this.state.currentTags.forEach(tag => {
                    const chip = document.createElement('div');
                    chip.className = 'tag-chip';
                    chip.innerHTML = `
                        <span>${tag}</span>
                        <span class="tag-close" onclick="app.removeTag('${tag}')" tabindex="0" role="button" aria-label="Remove ${tag} tag">&times;</span>
                    `;
                    container.appendChild(chip);
                });
            },

            togglePayable: function() {
                const cb = document.getElementById('entryPayable');
                if (cb) cb.checked = !cb.checked;
            },

            toggleAutoDelete: function() {
                const cb = document.getElementById('autoDeleteToggle');
                if (cb) {
                    cb.checked = !cb.checked;
                    this.state.autoDeleteEnabled = cb.checked;
                    localStorage.setItem('arthaNex_autoDelete', cb.checked);
                }
            },

            handleStatusChange: function() {
                const status = document.getElementById('entryStatus').value;
                const paidOpts = document.getElementById('paidOptions');
                const dueOpts = document.getElementById('dueOptions');
                const partialOpts = document.getElementById('partialOptions');

                if (paidOpts) paidOpts.style.display = 'none';
                if (dueOpts) dueOpts.style.display = 'none';
                if (partialOpts) partialOpts.style.display = 'none';

                if (status === 'Paid' && paidOpts) {
                    paidOpts.style.display = 'block';
                } else if (status === 'Due' && dueOpts) {
                    dueOpts.style.display = 'block';
                } else if (status === 'Partial' && partialOpts) {
                    partialOpts.style.display = 'block';
                }
            },

            calculatePartial: function() {
                const totalAmount = parseFloat(document.getElementById('partialTotalAmount').value) || 0;
                const collectedAmount = parseFloat(document.getElementById('partialCollectedAmount').value) || 0;
                const balanceAmount = totalAmount - collectedAmount;
                const balanceInput = document.getElementById('partialBalanceAmount');
                if (balanceInput) {
                    balanceInput.value = balanceAmount >= 0 ? balanceAmount.toFixed(2) : 0;
                }
            },

            updateDashboard: function() {
                const profileRecords = this.getProfileRecords();
                const totalIncome = profileRecords.filter(r => r.type === 'income').reduce((sum, r) => sum + r.total, 0);
                const totalExpense = profileRecords.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.total, 0);
                const netBalance = totalIncome - totalExpense;

                const dashIncome = document.getElementById('dashIncome');
                const dashExpense = document.getElementById('dashExpense');
                const dashBalance = document.getElementById('dashBalance');

                if (dashIncome) dashIncome.textContent = totalIncome.toLocaleString();
                if (dashExpense) dashExpense.textContent = totalExpense.toLocaleString();
                if (dashBalance) dashBalance.textContent = netBalance.toLocaleString();

                let dueRec = 0;
                let duePay = 0;

                profileRecords.forEach(r => {
                    if (r.status === 'Due') {
                        if (r.type === 'income') dueRec += r.total;
                        else if (r.type === 'expense') duePay += r.total;
                    } else if (r.status === 'Partial' && r.partialPayment) {
                        if (r.partialPayment.dueType === 'receivable') {
                            dueRec += r.partialPayment.balanceAmount;
                        } else {
                            duePay += r.partialPayment.balanceAmount;
                        }
                    }
                });

                const dueReceivable = document.getElementById('dueReceivable');
                const duePayable = document.getElementById('duePayable');
                if (dueReceivable) dueReceivable.textContent = dueRec.toLocaleString();
                if (duePayable) duePayable.textContent = duePay.toLocaleString();
            },

            loadDenominations: function() {
                const container = document.getElementById('denominationContainer');
                if (!container || !this.state.selectedCountry) return;

                container.innerHTML = '';
                this.state.denominations = {};
                this.state.selectedCountry.denominations.forEach(denom => {
                    this.state.denominations[denom] = 0;
                    const item = document.createElement('div');
                    item.className = 'denom-item';
                    item.innerHTML = `
                        <label class="denom-label">${denom}</label>
                        <input type="number" class="denom-input" min="0" oninput="app.calculateTotal('${denom}', this.value)" aria-label="Count for ${denom}">
                        <span class="denom-subtotal" id="sub_${denom}">0</span>
                    `;
                    container.appendChild(item);
                });
                this.calculateTotal();
            },

            calculateTotal: function(denomChanged, val) {
                if (denomChanged) this.state.denominations[denomChanged] = parseFloat(val) || 0;
                let total = 0;
                if (this.state.selectedCountry) {
                    this.state.selectedCountry.denominations.forEach(d => {
                        const count = this.state.denominations[d];
                        total += (count * d);
                        const subEl = document.getElementById(`sub_${d}`);
                        if (subEl) subEl.textContent = (count * d).toLocaleString();
                    });
                    const symbol = this.state.selectedCountry.symbol;
                    const displayTotal = document.getElementById('displayTotal');
                    const displayWords = document.getElementById('displayWords');
                    if (displayTotal) displayTotal.textContent = `${symbol} ${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
                    if (displayWords) displayWords.textContent = this.numberToWords(total) + " " + this.state.selectedCountry.currency;
                }
            },

            saveRecord: function() {
                if (!this.state.selectedCountry) {
                    this.showToast("Please select a country first in Settings.");
                    this.toggleModal('settingsModal');
                    return;
                }

                const nameInput = document.getElementById('entryName');
                const nameValue = nameInput.value.trim();
                if (nameValue === "") {
                    this.showToast("Please enter a Name (Mandatory Field).");
                    nameInput.classList.add('error');
                    nameInput.focus();
                    return;
                } else {
                    nameInput.classList.remove('error');
                }

                let hasEntries = false;
                let total = 0;
                Object.keys(this.state.denominations).forEach(k => {
                    const count = this.state.denominations[k];
                    total += (k * count);
                    if (count > 0) hasEntries = true;
                });

                if (!hasEntries) {
                    this.showToast("Denomination is Mandatory. Please enter at least one count.");
                    return;
                }

                const status = document.getElementById('entryStatus').value;
                let type = 'income';
                let partialData = null;

                if (status === 'Paid') {
                    const isPayable = document.getElementById('entryPayable').checked;
                    type = isPayable ? 'expense' : 'income';
                } else if (status === 'Partial') {
                    const partialTotal = parseFloat(document.getElementById('partialTotalAmount').value) || 0;
                    const partialCollected = parseFloat(document.getElementById('partialCollectedAmount').value) || 0;
                    const partialBalance = partialTotal - partialCollected;
                    const partialDueType = document.querySelector('input[name="partialDueType"]:checked')?.value || 'receivable';

                    if (partialTotal <= 0) {
                        this.showToast("Please enter Total Bill Amount for Partial Payment.");
                        return;
                    }
                    if (partialCollected < 0 || partialCollected > partialTotal) {
                        this.showToast("Collected amount must be between 0 and Total Amount.");
                        return;
                    }

                    type = (partialDueType === 'payable') ? 'expense' : 'income';
                    partialData = {
                        totalAmount: partialTotal,
                        collectedAmount: partialCollected,
                        balanceAmount: partialBalance,
                        dueType: partialDueType
                    };
                } else {
                    const dueType = document.querySelector('input[name="dueType"]:checked')?.value || 'receivable';
                    type = (dueType === 'payable') ? 'expense' : 'income';
                }

                const record = {
                    id: Date.now(),
                    profileId: this.state.currentProfileId,  // FIXED: Set profileId before push
                    type: type,
                    status: status,
                    country: this.state.selectedCountry.name,
                    currency: this.state.selectedCountry.currency,
                    symbol: this.state.selectedCountry.symbol,
                    date: document.getElementById('entryDate').value,
                    time: document.getElementById('entryTime').value,
                    name: nameValue,
                    mobile: document.getElementById('entryMobile').value || "",
                    tags: [...this.state.currentTags],
                    remarks: document.getElementById('entryRemarks').value || "",
                    denominations: {...this.state.denominations},
                    total: total,
                    timestamp: Date.now()
                };

                if (partialData) {
                    record.partialPayment = partialData;
                }

                this.state.records.push(record);

                try {
                    if (window.currentPin && typeof CryptoUtil !== 'undefined') {
                        const encrypted = CryptoUtil.encrypt(this.state.records, window.currentPin);
                        localStorage.setItem('arthaNex_records', 'ENC:' + encrypted);
                    } else {
                        localStorage.setItem('arthaNex_records', JSON.stringify(this.state.records));
                    }
                } catch (error) {
                    localStorage.setItem('arthaNex_records', JSON.stringify(this.state.records));
                }

                this.updateDashboard();
                this.renderHistory();
                this.renderOutstanding('all');
                this.showToast("Record Saved Successfully!");
                this.resetForm();
            },

            loadRecords: function() {
                try {
                    const stored = localStorage.getItem('arthaNex_records');
                    if (stored) {
                        if (stored.startsWith('ENC:')) {
                            this.state.records = [];
                        } else {
                            this.state.records = JSON.parse(stored);
                        }
                    }
                } catch (error) {
                    this.state.records = [];
                }
            },

            cleanupOldRecords: function() {
                if (!this.state.autoDeleteEnabled) return;
                try {
                    const now = Date.now();
                    const threeMonths = 90 * 24 * 60 * 60 * 1000;
                    const filtered = this.state.records.filter(r => (now - r.timestamp) < threeMonths);
                    if (filtered.length < this.state.records.length) {
                        this.state.records = filtered;
                        localStorage.setItem('arthaNex_records', JSON.stringify(this.state.records));
                    }
                } catch (error) {
                    // Silent error
                }
            },

            resetForm: function() {
                if (this.state.selectedCountry) this.loadDenominations();
                const nameInput = document.getElementById('entryName');
                if (nameInput) {
                    nameInput.value = "";
                    nameInput.classList.remove('error');
                }
                const mobileInput = document.getElementById('entryMobile');
                if (mobileInput) mobileInput.value = "";
                const remarksInput = document.getElementById('entryRemarks');
                if (remarksInput) remarksInput.value = "";
                this.state.currentTags = [];
                this.renderTags();
                const statusSelect = document.getElementById('entryStatus');
                if (statusSelect) statusSelect.value = 'Paid';
                const entryPayable = document.getElementById('entryPayable');
                if (entryPayable) entryPayable.checked = false;
                const dueTypeReceivable = document.querySelector('input[name="dueType"][value="receivable"]');
                if (dueTypeReceivable) dueTypeReceivable.checked = true;

                const partialTotal = document.getElementById('partialTotalAmount');
                const partialCollected = document.getElementById('partialCollectedAmount');
                const partialBalance = document.getElementById('partialBalanceAmount');
                if (partialTotal) partialTotal.value = "";
                if (partialCollected) partialCollected.value = "";
                if (partialBalance) partialBalance.value = "";
                const partialDueType = document.querySelector('input[name="partialDueType"][value="receivable"]');
                if (partialDueType) partialDueType.checked = true;

                this.handleStatusChange();
                const now = new Date();
                const entryDate = document.getElementById('entryDate');
                const entryTime = document.getElementById('entryTime');
                if (entryDate) entryDate.valueAsDate = now;
                if (entryTime) entryTime.value = now.toTimeString().substring(0,5);
            },

            setTheme: function(theme) {
                this.state.currentTheme = theme;
                document.body.setAttribute('data-theme', theme);
                document.documentElement.setAttribute('color-scheme', theme);
                const themeSelect = document.getElementById('themeSelect');
                if (themeSelect) themeSelect.value = theme;
                localStorage.setItem('arthaNex_theme', theme);
            },

            loadSettings: function() {
                try {
                    const savedTheme = localStorage.getItem('arthaNex_theme');
                    if (savedTheme) this.setTheme(savedTheme);

                    const savedColor = localStorage.getItem('arthaNex_primaryColor');
                    if (savedColor) this.setPrimaryColor(savedColor);

                    const autoDelete = localStorage.getItem('arthaNex_autoDelete');
                    if (autoDelete !== null) {
                        this.state.autoDeleteEnabled = (autoDelete === 'true');
                        const autoDeleteToggle = document.getElementById('autoDeleteToggle');
                        if (autoDeleteToggle) autoDeleteToggle.checked = this.state.autoDeleteEnabled;
                    }
                } catch (error) {
                    // Silent error
                }
            },

            toggleModal: function(id) {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.classList.toggle('open');
                    const isOpen = modal.classList.contains('open');
                    modal.setAttribute('aria-hidden', !isOpen);
                }
            },

            switchTab: function(id) {
                document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(e => {
                    e.classList.remove('active');
                    e.removeAttribute('aria-current');
                });

                const targetView = document.getElementById(id);
                if (targetView) targetView.classList.add('active');

                const btnIndex = ['home','entry','history','outstanding','ledger'].indexOf(id);
                const navBtns = document.querySelectorAll('.nav-btn');
                if (btnIndex >= 0 && navBtns[btnIndex]) {
                    navBtns[btnIndex].classList.add('active');
                    navBtns[btnIndex].setAttribute('aria-current', 'page');
                }

                if (id === 'history') this.renderHistory();
                if (id === 'outstanding') {
                    this.updateDashboard();
                    this.renderOutstanding('all');
                }
            },

            // ... (remaining functions will continue)
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>


    <!-- Additional App Functions -->
    <script>
        // Extend app with remaining functions
        Object.assign(app, {
            downloadInvoice: function(id) {
                try {
                    const r = this.state.records.find(rec => rec.id === id);
                    if (!r) return;

                    const symbol = r.symbol;
                    const currency = r.currency;
                    const totalInWords = this.numberToWords(r.total) + " " + r.currency;
                    const itemsDesc = (r.tags && r.tags.length > 0) ? 'Items: ' + r.tags.join(', ') : (r.remarks || "Payment Received");

                    let statusText = r.status === 'Paid' ? "PAID" : (r.status === 'Partial' ? "PARTIAL PAYMENT" : "DUE");
                    let statusColor = r.status === 'Paid' ? "#2e7d32" : (r.status === 'Partial' ? "#ff9800" : "#c62828");
                    const invoiceNo = "#INV-" + r.id.toString().slice(-6);

                    let partialSection = '';
                    if (r.status === 'Partial' && r.partialPayment) {
                        const pp = r.partialPayment;
                        partialSection = `
                            <div style="background:#fff3e0; padding:15px; border-radius:8px; margin-top:20px; border-left:4px solid #ff9800;">
                                <div style="font-weight:700; color:#e65100; margin-bottom:10px; font-size:14px;">&#128179; Payment Summary</div>
                                <table style="width:100%; font-size:13px;">
                                    <tr><td style="padding:5px 0; color:#555;">Total Bill Amount:</td><td style="padding:5px 0; text-align:right; font-weight:600;">${symbol} ${pp.totalAmount.toLocaleString()}</td></tr>
                                    <tr><td style="padding:5px 0; color:#555;">Amount Received:</td><td style="padding:5px 0; text-align:right; font-weight:600; color:#2e7d32;">${symbol} ${pp.collectedAmount.toLocaleString()}</td></tr>
                                    <tr style="border-top:1px solid #ddd;"><td style="padding:8px 0 5px 0; color:#c62828; font-weight:700;">Outstanding Balance:</td><td style="padding:8px 0 5px 0; text-align:right; font-weight:700; color:#c62828; font-size:15px;">${symbol} ${pp.balanceAmount.toLocaleString()}</td></tr>
                                    <tr><td colspan="2" style="padding-top:8px; font-size:11px; color:#666; font-style:italic;">${pp.dueType === 'receivable' ? '&#128229; Customer will pay the balance' : '&#128228; I have to pay the balance'}</td></tr>
                                </table>
                            </div>
                        `;
                    }

                    const invoiceHTML = `
                        <div class="invoice-layout">
                            <div class="inv-header">
                                <div class="inv-brand-info">
                                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                                        <img src="./logo.png" style="width:50px; height:50px;" alt="Logo">
                                        <h1>ArthaNex</h1>
                                    </div>
                                    <p>Professional Khata Book & Ledger</p>
                                </div>
                                <div class="inv-title-section">
                                    <div class="inv-title">Invoice</div>
                                    <div class="inv-meta-grid">
                                        <div class="inv-meta-label">Invoice No:</div><div class="inv-meta-value">${invoiceNo}</div>
                                        <div class="inv-meta-label">Date:</div><div class="inv-meta-value">${this.formatDisplayDate(r.date)}</div>
                                        <div class="inv-meta-label">Status:</div><div class="inv-meta-value" style="color:${statusColor}">${statusText}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="inv-bill-to">
                                <div class="inv-bill-label">Bill To</div>
                                <div class="inv-cust-name">${r.name}</div>
                                <div class="inv-cust-details">${r.mobile ? 'Mobile: ' + r.mobile + '<br>' : ''}${r.remarks ? 'Note: ' + r.remarks : ''}</div>
                            </div>
                            <table class="inv-table">
                                <thead><tr><th style="width: 50px;">#</th><th>Description</th><th style="width: 120px; text-align: right;">Amount</th></tr></thead>
                                <tbody>
                                    <tr><td>1</td><td><strong>${itemsDesc}</strong><br><span style="font-size:11px; color:#888;">Transaction ID: ${r.id}</span></td><td class="text-right">${symbol} ${r.total.toLocaleString()}</td></tr>
                                    <tr class="inv-total-row"><td colspan="2" class="text-right">Total</td><td class="text-right">${symbol} ${r.total.toLocaleString()}</td></tr>
                                </tbody>
                            </table>
                            <div class="inv-words"><strong>Amount in Words:</strong> ${totalInWords}</div>
                            ${partialSection}
                            <div class="inv-sign"><div class="inv-sign-line">Authorized Signature</div></div>
                            <div class="inv-footer-note">Thank you for your business.<br>Generated by ArthaNex | https://github.com/Pintusikder</div>
                        </div>
                    `;

                    const printArea = document.getElementById('print-area');
                    if (printArea) {
                        printArea.innerHTML = invoiceHTML;
                        window.print();
                    }
                } catch (error) {
                    this.showToast('Error generating invoice');
                }
            },

            formatDisplayDate: function(dateStr) {
                try {
                    const d = new Date(dateStr);
                    return d.toLocaleDateString('en-GB');
                } catch (error) {
                    return dateStr;
                }
            },

            formatDisplayDateTime: function() {
                const now = new Date();
                return now.toLocaleString('en-GB');
            },

            generatePDFReport: function(records, title, dateRangeStr) {
                try {
                    if (records.length === 0) {
                        this.showToast("No transactions available for selected period");
                        return;
                    }

                    const symbol = this.state.selectedCountry ? this.state.selectedCountry.symbol : '';
                    const currency = this.state.selectedCountry ? this.state.selectedCountry.currency : '';

                    let totalIncome = 0, totalExpense = 0, totalReceivable = 0, totalPayable = 0;

                    const tableRows = records.map((r, index) => {
                        let incomeVal = r.type === 'income' ? r.total : 0;
                        let expenseVal = r.type === 'expense' ? r.total : 0;
                        totalIncome += incomeVal;
                        totalExpense += expenseVal;

                        let rowClass = '', statusDisplay = '';
                        if (r.status === 'Paid') {
                            rowClass = 'row-green';
                            statusDisplay = 'Paid';
                        } else {
                            if (r.type === 'expense') {
                                rowClass = 'row-orange';
                                statusDisplay = 'Due (Payable)';
                                totalPayable += r.total;
                            } else {
                                rowClass = 'row-red';
                                statusDisplay = 'Due (Receivable)';
                                totalReceivable += r.total;
                            }
                        }

                        const amountInWords = this.numberToWords(r.total);
                        const typeDisplay = r.type === 'income' ? 'Income' : 'Expense';
                        const tagDisplay = r.tags && r.tags.length > 0 ? `<br><small style="color:#666">Items: ${r.tags.join(', ')}</small>` : '';

                        return `
                            <tr class="${rowClass}">
                                <td>${index + 1}</td>
                                <td>${this.formatDisplayDate(r.date)}</td>
                                <td>${r.time}</td>
                                <td><strong>${r.name}</strong>${tagDisplay}${r.mobile ? `<br><small>${r.mobile}</small>` : ''}</td>
                                <td>${r.remarks || '-'}</td>
                                <td>${typeDisplay}</td>
                                <td>${incomeVal > 0 ? symbol + ' ' + incomeVal.toLocaleString() : '-'}</td>
                                <td>${expenseVal > 0 ? symbol + ' ' + expenseVal.toLocaleString() : '-'}</td>
                                <td class="font-bold">${symbol} ${r.total.toLocaleString()}</td>
                                <td><small>${amountInWords} ${currency}</small></td>
                                <td><strong>${statusDisplay}</strong></td>
                            </tr>
                        `;
                    }).join('');

                    const netBalance = totalIncome - totalExpense;
                    const generatedOn = this.formatDisplayDateTime();

                    const htmlContent = `
                        <div class="pdf-header">
                            <div class="pdf-logo-area">
                                <img src="./logo.png" class="pdf-logo" alt="Logo">
                                <div class="pdf-title-block"><h1>ArthaNex</h1><h2>${title}</h2></div>
                            </div>
                            <div class="pdf-meta"><strong>Date Range:</strong><br>${dateRangeStr}<br><br><strong>Generated On:</strong><br>${generatedOn}</div>
                        </div>
                        <table class="pdf-table">
                            <thead><tr><th style="width: 30px;">Sl No</th><th style="width: 70px;">Date</th><th style="width: 60px;">Time</th><th style="width: 150px;">Name / Party</th><th style="width: 120px;">Remarks / Notes</th><th style="width: 60px;">Type</th><th>Income</th><th>Expense</th><th>Amount</th><th>Words</th><th style="width: 100px;">Payment Status</th></tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                        <div class="pdf-summary-box">
                            <div class="pdf-summary-row"><span class="pdf-summary-label">Total Income:</span><span class="pdf-summary-val" style="color:green">${symbol} ${totalIncome.toLocaleString()}</span></div>
                            <div class="pdf-summary-row"><span class="pdf-summary-label">Total Expense:</span><span class="pdf-summary-val" style="color:red">${symbol} ${totalExpense.toLocaleString()}</span></div>
                            <div class="pdf-summary-row"><span class="pdf-summary-label">Total Receivable (Due - Income):</span><span class="pdf-summary-val" style="color:#b71c1c">${symbol} ${totalReceivable.toLocaleString()}</span></div>
                            <div class="pdf-summary-row"><span class="pdf-summary-label">Total Payable (Due - Expense):</span><span class="pdf-summary-val" style="color:#e65100">${symbol} ${totalPayable.toLocaleString()}</span></div>
                            <div class="pdf-summary-row"><span class="pdf-summary-label">Net Balance (Income - Expense):</span><span class="pdf-summary-val">${symbol} ${netBalance.toLocaleString()}</span></div>
                        </div>
                        <div class="pdf-footer">https://github.com/Pintusikder</div>
                    `;

                    const printArea = document.getElementById('print-area');
                    if (printArea) {
                        printArea.innerHTML = htmlContent;
                        window.print();
                    }
                } catch (error) {
                    this.showToast('Error generating report');
                }
            },

            exportLast30Days: function() {
                try {
                    const today = new Date();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(today.getDate() - 30);

                    const todayStr = today.toISOString().split('T')[0];
                    const startStr = thirtyDaysAgo.toISOString().split('T')[0];

                    const filtered = this.state.records.filter(r => r.date >= startStr && r.date <= todayStr);

                    if (filtered.length === 0) {
                        this.showToast("No transactions in last 30 days.");
                        return;
                    }

                    const rangeStr = `From: ${this.formatDisplayDate(startStr)} To: ${this.formatDisplayDate(todayStr)}`;
                    this.generatePDFReport(filtered, "30 Days Transaction Report", rangeStr);
                } catch (error) {
                    this.showToast('Error exporting data');
                }
            },

            openRangeModal: function() {
                this.toggleModal('dateRangeModal');
            },

            generateRangeReport: function() {
                try {
                    const startStr = document.getElementById('rangeStart').value;
                    const endStr = document.getElementById('rangeEnd').value;

                    if (!startStr || !endStr) {
                        this.showToast("Please select both dates.");
                        return;
                    }
                    if (startStr > endStr) {
                        this.showToast("Invalid date range.");
                        return;
                    }

                    const filtered = this.state.records.filter(r => r.date >= startStr && r.date <= endStr);

                    if (filtered.length === 0) {
                        this.showToast("No records found for this range.");
                        this.toggleModal('dateRangeModal');
                        return;
                    }

                    const startDisplay = this.formatDisplayDate(startStr);
                    const endDisplay = this.formatDisplayDate(endStr);
                    const rangeDisplay = `From: ${startDisplay} To: ${endDisplay}`;

                    this.generatePDFReport(filtered, "Transaction Report (Date Range)", rangeDisplay);
                    this.toggleModal('dateRangeModal');
                } catch (error) {
                    this.showToast('Error generating report');
                }
            },

            renderOutstanding: function(filterType) {
                try {
                    const list = document.getElementById('outstandingList');
                    const empty = document.getElementById('outstandingEmpty');
                    if (!list) return;
                    list.innerHTML = '';

                    let dues = this.state.records.filter(r => r.status === 'Due');
                    if (filterType === 'receivable') dues = dues.filter(r => r.type === 'income');
                    else if (filterType === 'payable') dues = dues.filter(r => r.type === 'expense');

                    if (dues.length === 0) {
                        if (empty) empty.style.display = 'block';
                    } else {
                        if (empty) empty.style.display = 'none';
                        dues.sort((a, b) => b.timestamp - a.timestamp).forEach(r => {
                            const li = document.createElement('li');
                            li.className = 'history-item';
                            const typeBadge = r.type === 'income' ? '<span class="badge receivable">Receivable</span>' : '<span class="badge expense">Payable</span>';
                            const amountClass = r.type === 'income' ? 'amount-income' : 'amount-expense';

                            li.innerHTML = `
                                <div class="h-left">
                                    <span class="h-name">${typeBadge} ${r.name}</span>
                                    <div class="h-details">
                                        <div class="h-detail-row"><span>&#128197;</span> <span>${r.date}</span></div>
                                        <div class="h-detail-row"><span>&#128221;</span> <span>${r.remarks || 'No remarks'}</span></div>
                                    </div>
                                </div>
                                <div class="h-right">
                                    <span class="h-amount ${amountClass}">${r.symbol} ${r.total.toLocaleString()}</span>
                                    <button class="btn btn-success" style="margin-top:5px; padding:4px 8px; font-size:0.8rem;" onclick="app.settleDue(${r.id})" aria-label="Mark as Paid">Mark Paid</button>
                                </div>
                            `;
                            list.appendChild(li);
                        });
                    }
                } catch (error) {
                    this.showToast('Error loading outstanding dues');
                }
            },

            settleDue: function(id) {
                if (confirm('Mark this record as Paid/Cleared today?')) {
                    try {
                        const rIndex = this.state.records.findIndex(r => r.id === id);
                        if (rIndex > -1) {
                            this.state.records[rIndex].status = 'Paid';
                            localStorage.setItem('arthaNex_records', JSON.stringify(this.state.records));
                            this.updateDashboard();
                            this.renderOutstanding('all');
                            this.showToast('Record marked as Paid!');
                        }
                    } catch (error) {
                        this.showToast('Error updating record');
                    }
                }
            },

            suggestLedgerName: function(val) {
                try {
                    const container = document.getElementById('ledgerSuggestions');
                    if (!container) return;
                    container.innerHTML = '';
                    if (val.length < 1) return;

                    const names = [...new Set(this.state.records.map(r => r.name))].filter(n => n.toLowerCase().includes(val.toLowerCase()));
                    names.forEach(name => {
                        const tag = document.createElement('span');
                        tag.textContent = name;
                        tag.style.cssText = "background:var(--light-bg); padding:4px 8px; border-radius:4px; font-size:0.8rem; border:1px solid var(--border); cursor:pointer; word-break: break-word;";
                        tag.onclick = () => {
                            const searchInput = document.getElementById('ledgerSearch');
                            if (searchInput) searchInput.value = name;
                            this.loadLedger(name);
                            container.innerHTML = '';
                        };
                        container.appendChild(tag);
                    });
                } catch (error) {
                    // Silent error
                }
            },

            loadLedger: function(name) {
                try {
                    const custRecords = this.state.records.filter(r => r.name === name);
                    if (custRecords.length === 0) return;

                    const ledgerDetails = document.getElementById('ledgerDetails');
                    const ledgerEmpty = document.getElementById('ledgerEmpty');
                    const ledgerCustomerName = document.getElementById('ledgerCustomerName');

                    if (ledgerDetails) ledgerDetails.style.display = 'block';
                    if (ledgerEmpty) ledgerEmpty.style.display = 'none';
                    if (ledgerCustomerName) ledgerCustomerName.textContent = name;

                    const totalRec = custRecords.filter(r => r.type === 'income').reduce((sum, r) => sum + r.total, 0);
                    const totalPaid = custRecords.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.total, 0);

                    const ledgerTotalReceived = document.getElementById('ledgerTotalReceived');
                    const ledgerTotalPaid = document.getElementById('ledgerTotalPaid');
                    if (ledgerTotalReceived) ledgerTotalReceived.textContent = totalRec.toLocaleString();
                    if (ledgerTotalPaid) ledgerTotalPaid.textContent = totalPaid.toLocaleString();

                    const net = totalRec - totalPaid;
                    const netEl = document.getElementById('ledgerNetBalance');
                    if (netEl) {
                        netEl.textContent = net.toLocaleString();
                        netEl.style.color = net >= 0 ? 'var(--text-balance)' : 'var(--text-expense)';
                    }

                    const list = document.getElementById('ledgerList');
                    if (list) {
                        list.innerHTML = '';
                        custRecords.sort((a, b) => b.timestamp - a.timestamp).forEach(r => {
                            const li = document.createElement('li');
                            li.className = 'history-item';
                            const amountClass = r.type === 'income' ? 'amount-income' : 'amount-expense';
                            li.innerHTML = `
                                <div class="h-left">
                                    <span class="h-name">${r.date}</span>
                                    <div class="h-details">
                                        <div class="h-detail-row"><span>${r.remarks || 'No remarks'}</span></div>
                                        <div class="h-detail-row"><span>Status:</span> <span>${r.status}</span></div>
                                    </div>
                                </div>
                                <div class="h-right">
                                    <span class="h-amount ${amountClass}">${r.symbol} ${r.total.toLocaleString()}</span>
                                </div>
                            `;
                            list.appendChild(li);
                        });
                    }
                } catch (error) {
                    this.showToast('Error loading ledger');
                }
            },

            clearLedger: function() {
                const searchInput = document.getElementById('ledgerSearch');
                if (searchInput) searchInput.value = '';
                const ledgerDetails = document.getElementById('ledgerDetails');
                if (ledgerDetails) ledgerDetails.style.display = 'none';
                const ledgerEmpty = document.getElementById('ledgerEmpty');
                if (ledgerEmpty) ledgerEmpty.style.display = 'block';
                const ledgerSuggestions = document.getElementById('ledgerSuggestions');
                if (ledgerSuggestions) ledgerSuggestions.innerHTML = '';
            },

            setFilterMode: function(mode) {
                this.state.filters.mode = mode;
                const inputs = document.querySelectorAll('.filter-input');
                inputs.forEach(input => input.style.display = 'none');

                if (mode === 'name') {
                    const filterName = document.getElementById('filterName');
                    if (filterName) filterName.style.display = 'block';
                } else if (mode === 'date') {
                    const filterDate = document.getElementById('filterDate');
                    if (filterDate) filterDate.style.display = 'block';
                } else if (mode === 'amount') {
                    const filterAmount = document.getElementById('filterAmount');
                    if (filterAmount) filterAmount.style.display = 'block';
                }

                this.renderHistory();
            },

            handleFilter: function(type, value) {
                if (this.state.filters.mode !== type) return;
                this.state.filters[type] = value;
                this.renderHistory();
            },

            closeAllMenus: function() {
                document.querySelectorAll('.item-menu').forEach(el => el.classList.remove('show'));
            },

            toggleMenu: function(id, event) {
                if (event) event.stopPropagation();
                this.closeAllMenus();
                const menu = document.getElementById(`menu-${id}`);
                if (menu) menu.classList.add('show');
            },

            renderHistory: function() {
                try {
                    const list = document.getElementById('historyList');
                    const emptyState = document.getElementById('emptyState');
                    if (!list) return;

                    const { name, date, amount, mode } = this.state.filters;
                    list.innerHTML = '';

                    const filtered = this.state.records.filter(r => {
                        if (mode === 'name') return name ? r.name.toLowerCase().includes(name.toLowerCase()) : true;
                        else if (mode === 'date') return date ? r.date === date : true;
                        else if (mode === 'amount') return amount ? r.total.toString().startsWith(amount.toString()) : true;
                        return true;
                    });

                    if (mode === 'amount') filtered.sort((a, b) => a.total - b.total);
                    else filtered.sort((a, b) => b.timestamp - a.timestamp);

                    if (filtered.length === 0) {
                        if (emptyState) emptyState.style.display = 'block';
                    } else {
                        if (emptyState) emptyState.style.display = 'none';
                        filtered.forEach(r => {
                            const li = document.createElement('li');
                            li.className = 'history-item';
                            let statusBadge = r.status === 'Due' ? '<span class="badge due">Due</span>' : '';
                            if (r.type === 'expense') statusBadge += '<span class="badge expense">Payable</span>';

                            const amountClass = r.type === 'expense' ? 'amount-expense' : 'amount-income';
                            const amountWords = this.numberToWords(r.total) + " " + r.currency;
                            const tagsHtml = r.tags && r.tags.length > 0 ? `<div class="h-tags">&#127991; ${r.tags.join(', ')}</div>` : '';

                            li.innerHTML = `
                                <div class="h-left">
                                    <span class="h-name">${statusBadge} ${r.name}</span>
                                    ${tagsHtml}
                                    <div class="h-details">
                                        ${r.mobile ? `<div class="h-detail-row"><span>&#128241;</span> <span>${r.mobile}</span></div>` : ''}
                                        ${r.remarks ? `<div class="h-detail-row"><span>&#128221;</span> <span>${r.remarks}</span></div>` : ''}
                                        <div class="h-detail-row" style="font-size:0.75rem; opacity:0.8;">${r.date} &bull; ${r.country}</div>
                                    </div>
                                </div>
                                <div class="h-right">
                                    <span class="h-amount ${amountClass}">${r.symbol} ${r.total.toLocaleString()}</span>
                                    <span class="h-words" title="${amountWords}">${amountWords}</span>
                                    <div class="menu-container">
                                        <button class="btn-menu" onclick="app.toggleMenu(${r.id}, event)" aria-label="Menu">&#8942;</button>
                                        <div class="item-menu" id="menu-${r.id}">
                                            <button class="menu-opt" onclick="event.stopPropagation(); event.preventDefault(); app.downloadInvoice(${r.id})" aria-label="Download Invoice">&#128229; Download Invoice</button>
                                            <button class="menu-opt" onclick="event.stopPropagation(); event.preventDefault(); app.viewRecord(${r.id})" aria-label="View Details">&#128065; View Details</button>
                                            <button class="menu-opt" onclick="event.stopPropagation(); event.preventDefault(); app.copyRecord(${r.id})" aria-label="Copy Record">&#128203; Copy</button>
                                            <button class="menu-opt" onclick="event.stopPropagation(); event.preventDefault(); app.shareRecord(${r.id})" aria-label="Share Record">&#128279; Share</button>
                                            <button class="menu-opt delete" onclick="event.stopPropagation(); event.preventDefault(); app.deleteRecord(${r.id})" aria-label="Delete Record">&#128465; Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            list.appendChild(li);
                        });
                    }
                } catch (error) {
                    this.showToast('Error loading history');
                }
            },

            viewRecord: function(id) {
                try {
                    const r = this.state.records.find(rec => rec.id === id);
                    if (!r) return;

                    let breakdownHTML = '';
                    Object.keys(r.denominations).forEach(denom => {
                        const count = r.denominations[denom];
                        if (count > 0) breakdownHTML += `<div class="denom-br-row"><span>${r.symbol} ${denom} x ${count}</span><span>${r.symbol} ${(count*denom).toLocaleString()}</span></div>`;
                    });
                    if (breakdownHTML === '') breakdownHTML = '<div style="text-align:center; padding:10px; opacity:0.7;">No denomination breakdown found.</div>';

                    const inWords = this.numberToWords(r.total) + " " + r.currency;
                    const typeBadge = r.type === 'expense' ? '<span class="badge expense">Payable</span>' : '<span class="badge receivable">Income</span>';
                    const statusBadge = r.status === 'Due' ? '<span class="badge due">Due</span>' : '';
                    const tagsHtml = r.tags && r.tags.length > 0 ? `<div class="detail-row"><span>Items:</span> <span>${r.tags.join(', ')}</span></div>` : '';

                    let transactionText = "";
                    if (r.type === 'income') transactionText = (r.status === 'Paid') ? "Received From" : "Receivable From";
                    else transactionText = (r.status === 'Paid') ? "Paid To" : "Payable To";

                    const detailContent = document.getElementById('detailContent');
                    if (detailContent) {
                        detailContent.innerHTML = `
                            <div class="detail-row" style="font-size:1rem; border-bottom: 2px solid var(--border); margin-bottom:12px;"><span>Transaction:</span> <span style="color:var(--primary); font-weight:700;">${transactionText} <span style="text-decoration:underline;">${r.name}</span></span></div>
                            <div class="detail-row"><span>Status:</span> <span>${typeBadge} ${statusBadge}</span></div>
                            <div class="detail-row"><span>Date:</span> <span>${r.date} ${r.time}</span></div>
                            ${tagsHtml}
                            <div class="detail-row"><span>Total:</span> <span style="color:var(--primary)">${r.symbol} ${r.total.toLocaleString()}</span></div>
                            <div class="detail-row"><span>In Words:</span> <span style="font-style:italic; font-size: 0.8rem;">${inWords}</span></div>
                            <div class="detail-row"><span>Remarks:</span> <span>${r.remarks || '-'}</span></div>
                            <h4 style="margin: 15px 0 10px 0; font-size: 0.9rem; color: var(--neutral);">Denomination Breakdown</h4>
                            <div class="denom-breakdown">${breakdownHTML}</div>
                        `;
                    }
                    this.toggleModal('viewDetailModal');
                } catch (error) {
                    this.showToast('Error viewing record');
                }
            },

            copyRecord: function(id) {
                try {
                    const r = this.state.records.find(rec => rec.id === id);
                    if (!r) return;

                    let transactionText = "";
                    if (r.type === 'income') transactionText = (r.status === 'Paid') ? "Received From" : "Receivable From";
                    else transactionText = (r.status === 'Paid') ? "Paid To" : "Payable To";

                    const text = `Transaction: ${transactionText} ${r.name}
Amount: ${r.symbol}${r.total}
Status: ${r.status}
Date: ${r.date}
Remarks: ${r.remarks}`;

                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text).then(() => this.showToast("Copied!")).catch(() => this.showToast("Failed"));
                    } else {
                        this.showToast("Clipboard not supported");
                    }
                } catch (error) {
                    this.showToast('Error copying record');
                }
            },

            shareRecord: function(id) {
                try {
                    const r = this.state.records.find(rec => rec.id === id);
                    if (!r) return;

                    let transactionText = "";
                    if (r.type === 'income') transactionText = (r.status === 'Paid') ? "Received From" : "Receivable From";
                    else transactionText = (r.status === 'Paid') ? "Paid To" : "Payable To";

                    const msg = `ArthaNex:
Transaction: ${transactionText} ${r.name}
Amount: ${r.symbol}${r.total}
Date: ${r.date}

Download App: https://github.com/Pintusikder`;

                    if (navigator.share) {
                        navigator.share({ title: 'Record', text: msg }).catch(() => {});
                    } else {
                        this.showToast("Share not supported");
                    }
                } catch (error) {
                    this.showToast('Error sharing record');
                }
            },

            deleteRecord: function(id) {
                try {
                    const recordId = Number(id);
                    const index = this.state.records.findIndex(r => r.id === recordId);

                    if (index === -1) {
                        this.showToast("Record not found.");
                        return;
                    }

                    if (confirm("Are you sure you want to delete this record?")) {
                        this.state.records.splice(index, 1);
                        localStorage.setItem('arthaNex_records', JSON.stringify(this.state.records));
                        this.updateDashboard();
                        this.closeAllMenus();
                        this.renderHistory();
                        this.showToast("Record deleted.");
                    }
                } catch (error) {
                    this.showToast('Error deleting record');
                }
            },

            showToast: function(msg) {
                const el = document.getElementById('toast');
                if (el) {
                    el.textContent = msg;
                    el.className = "show";
                    setTimeout(() => { el.className = el.className.replace("show", ""); }, 3000);
                }
            },

            numberToWords: function(num) {
                if (num === 0) return "Zero";
                const a = ['','One ','Two ','Three ','Four ','Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
                const b = ['', '', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];

                const numStr = num.toString();
                const n = ('00000000000' + numStr).substr(-11).match(/^(\d{2})(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);

                if (!n) return numStr;

                let str = '';
                str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Arab ' : '';
                str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Crore ' : '';
                str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Lakh ' : '';
                str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Thousand ' : '';
                str += (n[5] != 0) ? (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + 'Hundred ' : '';
                str += (n[6] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[6])] || b[n[6][0]] + ' ' + a[n[6][1]]) : '';

                return str.trim();
            }
        });
    </script>


    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        // Service worker registered successfully
                    })
                    .catch(err => {
                        // Service worker registration failed
                    });
            });
        }
    </script>

    <!-- Encryption & PIN Lock System -->
    <script>
        const CryptoUtil = {
            async deriveKey(pin) {
                const encoder = new TextEncoder();
                const pinData = encoder.encode(pin);

                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw", pinData, { name: "PBKDF2" }, false, ["deriveKey"]
                );

                const salt = window.crypto.getRandomValues(new Uint8Array(16));

                const key = await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    false,
                    ["encrypt", "decrypt"]
                );

                return { key, salt };
            },

            async deriveKeyWithSalt(pin, salt) {
                const encoder = new TextEncoder();
                const pinData = encoder.encode(pin);

                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw", pinData, { name: "PBKDF2" }, false, ["deriveKey"]
                );

                const key = await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    false,
                    ["encrypt", "decrypt"]
                );

                return key;
            },

            async encrypt(data, pin) {
                const encoder = new TextEncoder();
                const dataBuffer = encoder.encode(JSON.stringify(data));

                const { key, salt } = await this.deriveKey(pin);
                const iv = window.crypto.getRandomValues(new Uint8Array(12));

                const encryptedBuffer = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv }, key, dataBuffer
                );

                const result = new Uint8Array(salt.length + iv.length + encryptedBuffer.byteLength);
                result.set(salt, 0);
                result.set(iv, salt.length);
                result.set(new Uint8Array(encryptedBuffer), salt.length + iv.length);

                return btoa(String.fromCharCode(...result));
            },

            async decrypt(encryptedBase64, pin) {
                try {
                    const encryptedData = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                    const salt = encryptedData.slice(0, 16);
                    const iv = encryptedData.slice(16, 28);
                    const ciphertext = encryptedData.slice(28);

                    const key = await this.deriveKeyWithSalt(pin, salt);

                    const decryptedBuffer = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv }, key, ciphertext
                    );

                    const decoder = new TextDecoder();
                    return JSON.parse(decoder.decode(decryptedBuffer));
                } catch (e) {
                    throw new Error("Invalid PIN or corrupted data");
                }
            }
        };

        const PinLock = {
            isLocked: true,
            hasPin: false,
            pinHint: "",
            maxAttempts: 5,
            attempts: 0,

            init() {
                try {
                    const savedPin = localStorage.getItem('arthaNex_pinHash');
                    const savedHint = localStorage.getItem('arthaNex_pinHint');

                    if (savedPin) {
                        this.hasPin = true;
                        this.pinHint = savedHint || "";
                        this.showLockScreen();
                    } else {
                        app.fullInit();
                    }
                } catch (error) {
                    app.fullInit();
                }
            },

            showLockScreen() {
                const lockHtml = `
                    <div id="pinLockScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--light-bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: var(--card-bg); padding: 2.5rem; border-radius: var(--radius-lg); max-width: 400px; width: 100%; box-shadow: var(--shadow-md); text-align: center;">
                            <div style="width: 80px; height: 80px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto;" aria-hidden="true">
                                <span style="font-size: 2.5rem;">&#128274;</span>
                            </div>
                            <h2 style="color: var(--text-color); margin-bottom: 0.5rem;">App Locked</h2>
                            <p style="color: var(--neutral); margin-bottom: 2rem; font-size: 0.9rem;">Enter your PIN to unlock</p>
                            <div class="form-group">
                                <input type="password" id="unlockPinInput" class="form-control" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;" style="text-align: center; font-size: 1.5rem; letter-spacing: 10px; margin-bottom: 1rem;" aria-label="Enter PIN">
                            </div>
                            <button class="btn btn-primary" onclick="PinLock.unlock()" style="margin-bottom: 1rem;" aria-label="Unlock">Unlock</button>
                            ${this.pinHint ? `<button id="hintBtn" class="btn btn-outline" onclick="PinLock.showHint()" style="font-size: 0.85rem; display: none;" aria-label="Show Hint">&#128161; Show Hint</button>` : ''}
                            <div id="pinError" style="color: #dc3545; margin-top: 1rem; font-size: 0.85rem; display: none;" role="alert" aria-live="assertive"></div>
                            <div id="hintMessage" style="color: #ff9800; margin-top: 0.5rem; font-size: 0.8rem; display: none;" role="alert">&#128161; Need help? Click "Show Hint" button above</div>
                            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <p style="font-size: 0.75rem; color: #dc3545; margin: 0;">&#9888; If you forget your PIN, all data will be permanently deleted<br><span style="font-size: 0.7rem;">No reset option available.</span></p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', lockHtml);
                setTimeout(() => {
                    const input = document.getElementById('unlockPinInput');
                    if (input) input.focus();
                }, 100);
            },

            async unlock() {
                try {
                    const pinInput = document.getElementById('unlockPinInput');
                    const pin = pinInput ? pinInput.value : '';
                    const hashedPin = await this.hashPin(pin);
                    const savedHash = localStorage.getItem('arthaNex_pinHash');

                    if (hashedPin === savedHash) {
                        const lockScreen = document.getElementById('pinLockScreen');
                        if (lockScreen) lockScreen.remove();
                        this.isLocked = false;
                        this.attempts = 0;
                        window.currentPin = pin;
                        await this.loadDecryptedData(pin);
                        app.updateDashboard();
                        const outstandingSection = document.getElementById('outstanding');
                        if (outstandingSection && outstandingSection.classList.contains('active')) {
                            app.renderOutstanding('all');
                        }
                        app.showToast('Unlocked successfully');
                    } else {
                        this.attempts++;
                        const pinError = document.getElementById('pinError');
                        const hintBtn = document.getElementById('hintBtn');
                        const hintMessage = document.getElementById('hintMessage');

                        if (pinError) {
                            if (this.attempts === 4) {
                                // 4th attempt - show warning
                                pinError.textContent = `Incorrect PIN. 1 attempt remaining. Data will be cleared after next failed attempt!`;
                                pinError.style.color = '#c62828';
                            } else {
                                pinError.textContent = `Incorrect PIN. ${this.maxAttempts - this.attempts} attempts remaining.`;
                            }
                            pinError.style.display = 'block';
                        }

                        // Show hint button after 3 failed attempts
                        if (this.attempts >= 3 && hintBtn) {
                            hintBtn.style.display = 'inline-block';
                            if (hintMessage) hintMessage.style.display = 'block';
                        }

                        if (pinInput) {
                            pinInput.value = '';
                            pinInput.focus();
                        }

                        if (this.attempts >= this.maxAttempts) {
                            this.clearAllData();
                        }
                    }
                } catch (error) {
                    app.showToast('Error unlocking app');
                }
            },

            clearAllData() {
                localStorage.clear();
                app.showToast('Too many failed attempts. All data cleared.');
                setTimeout(() => location.reload(), 2000);
            },

            showHint() {
                if (this.pinHint) {
                    alert('&#128161; Hint: ' + this.pinHint);
                }
            },

            async hashPin(pin) {
                const encoder = new TextEncoder();
                const data = encoder.encode(pin);
                const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

            async loadDecryptedData(pin) {
                try {
                    const encRecords = localStorage.getItem('arthaNex_records');
                    if (encRecords && encRecords.startsWith('ENC:')) {
                        const decrypted = await CryptoUtil.decrypt(encRecords.substring(4), pin);
                        app.state.records = decrypted || [];
                    } else if (encRecords) {
                        app.state.records = JSON.parse(encRecords) || [];
                    } else {
                        app.state.records = [];
                    }

                    const encProfiles = localStorage.getItem('arthaNex_profiles');
                    if (encProfiles && encProfiles.startsWith('ENC:')) {
                        const decrypted = await CryptoUtil.decrypt(encProfiles.substring(4), pin);
                        app.state.profiles = decrypted || [{ id: 1, name: "My Business" }];
                    } else if (encProfiles) {
                        app.state.profiles = JSON.parse(encProfiles) || [{ id: 1, name: "My Business" }];
                    } else {
                        app.state.profiles = [{ id: 1, name: "My Business" }];
                    }

                    const savedProfileId = localStorage.getItem('arthaNex_currentProfileId');
                    if (savedProfileId) {
                        app.state.currentProfileId = parseInt(savedProfileId);
                    }

                    app.setupDropdowns();
                    app.cleanupOldRecords();
                    app.migrateRecordsToProfile();

                    const savedCountryName = localStorage.getItem('arthaNex_lastCountry');
                    if (savedCountryName) {
                        const savedCountry = app.state.config.find(c => c.name === savedCountryName);
                        if (savedCountry) app.selectCountry(savedCountry);
                    }

                    app.updateHeaderProfileDisplay();
                    app.renderProfileList();

                    const now = new Date();
                    const entryDate = document.getElementById('entryDate');
                    const entryTime = document.getElementById('entryTime');
                    if (entryDate) entryDate.valueAsDate = now;
                    if (entryTime) entryTime.value = now.toTimeString().substring(0,5);

                    const todayStr = now.toISOString().split('T')[0];
                    const filterDate = document.getElementById('filterDate');
                    const rangeStart = document.getElementById('rangeStart');
                    const rangeEnd = document.getElementById('rangeEnd');
                    if (filterDate) filterDate.max = todayStr;
                    if (rangeStart) rangeStart.max = todayStr;
                    if (rangeEnd) rangeEnd.max = todayStr;

                    const settingsBtn = document.getElementById('settingsBtn');
                    if (settingsBtn) settingsBtn.addEventListener('click', () => app.toggleModal('settingsModal'));

                    window.addEventListener('click', (e) => {
                        if (!e.target.closest('.menu-container')) app.closeAllMenus();
                        if (e.target.classList.contains('modal')) e.target.classList.remove('open');
                    });

                    app.switchTab('home');
                } catch (error) {
                    app.showToast('Error loading data');
                }
            }
        };

        // Override app.init for PIN lock
        const originalInit = app.init;
        app.init = async function() {
            try {
                const hasPin = localStorage.getItem('arthaNex_pinHash');
                if (hasPin) {
                    PinLock.init();
                    this.loadSettings();
                } else {
                    this.fullInit();
                }
            } catch (error) {
                this.fullInit();
            }
        };
    </script>

    <!-- User Guide Function -->
    <script>
        function showUserGuide() {
            const guideHtml = `
            <div id="userGuideModal" class="modal open" style="z-index: 11000;" role="dialog" aria-labelledby="guideTitle" aria-modal="true">
                <div class="modal-content" style="max-width: 600px; max-height: 85vh; padding: 0; overflow: hidden;">
                    <div style="background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
                        <h2 id="guideTitle" style="margin: 0; font-size: 1.2rem;">&#128214; User Guide</h2>
                        <button onclick="document.getElementById('userGuideModal').remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;" aria-label="Close Guide">&times;</button>
                    </div>
                    <div style="padding: 1.2rem; overflow-y: auto; max-height: calc(85vh - 60px); line-height: 1.6; font-size: 0.95rem;">
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #2196f3;">
                            <p style="margin: 0; color: #1565c0; font-size: 0.9rem;">Welcome to ArthaNex - Your Digital Khata Book. This guide works on all devices (Mobile, Tablet, Desktop).</p>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;">&#128640; Getting Started</h3>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.5rem;"><strong>First Time:</strong> Set a PIN for security (optional)</li>
                                <li style="margin-bottom: 0.5rem;"><strong>Select Country:</strong> Choose your currency from the dropdown</li>
                                <li><strong>Create Profile:</strong> Go to Settings to add your business name</li>
                            </ul>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;">&#10133; Adding a Transaction</h3>
                            <ol style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li style="margin-bottom: 0.5rem;">Go to <strong>Entry</strong> tab</li>
                                <li style="margin-bottom: 0.5rem;">Select date, time, and customer name</li>
                                <li style="margin-bottom: 0.5rem;">Add mobile number (optional)</li>
                                <li style="margin-bottom: 0.5rem;">Count cash using <strong>Denomination Counter</strong></li>
                                <li style="margin-bottom: 0.5rem;">Select <strong>Paid</strong> or <strong>Due</strong></li>
                                <li>Click <strong>Save Record</strong></li>
                            </ol>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.1rem;">&#128202; Dashboard</h3>
                            <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">Track your business finances:</p>
                            <ul style="margin: 0; padding-left: 1.2rem; color: var(--text-color);">
                                <li><strong>Income:</strong> Money received</li>
                                <li><strong>Expense:</strong> Money paid</li>
                                <li><strong>Balance:</strong> Income minus Expense</li>
                            </ul>
                        </div>
                        <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <h4 style="color: #2e7d32; margin: 0 0 0.5rem 0; font-size: 1rem;">&#10067; Need Help?</h4>
                            <p style="margin: 0; font-size: 0.85rem; color: #1b5e20;">&#9993; <strong>Email:</strong> easyassistance@zohomail.in<br>&#127760; <strong>Website:</strong> arthixa.com</p>
                        </div>
                    </div>
                    <div style="padding: 1rem; border-top: 1px solid var(--border); text-align: center; position: sticky; bottom: 0; background: var(--card-bg);">
                        <button onclick="document.getElementById('userGuideModal').remove()" class="btn btn-primary" style="max-width: 200px;" aria-label="Got It">Got It</button>
                    </div>
                </div>
            </div>
            `;
            document.body.insertAdjacentHTML('beforeend', guideHtml);
        }
    </script>

    <!-- Hidden SEO Content -->
    <div style="display: none; visibility: hidden; position: absolute; left: -9999px;" aria-hidden="true">
        <h1>Best Khata Book App 2025 - Digital Udhar Bahi Khata</h1>
        <h2>Free Offline Business Ledger & Credit Debit Book</h2>
        <p>ArthaNex is the top rated digital khata book app for small business owners and shopkeepers. Maintain your udhar bahi electronically without internet. Best credit debit book application with party ledger management, daily cash book, money manager, and business calculator. Download free bahi khata app for android and ios. Manage len den hisab, dukan ka hisab, and vyapar accounting easily.</p>
    </div>
</body>
</html>
